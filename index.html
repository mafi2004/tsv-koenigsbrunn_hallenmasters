<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSV Königsbrunn – Hallenmasters | Funino: Nächste Runde (Champions-League-Modus)</title>
  <meta name="description" content="Funino-Spielplan: pro Gruppe nur die nächste Runde. Champions-League-Modus: W1–W2, W3–L1, L3–L2. Nächste Runde erst nach 3 Ergebnissen. Sticky-Header fixiert mit dynamischem Offset." />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent-2:#3b82f6; --warn:#f59e0b; --error:#ef4444;
      --groupA:#10b981; --groupB:#f97316; --groupC:#6366f1;
      /* Sticky-Header Fix */
      --page-header-height: 64px;   /* Fallback, wird per JS dynamisch gesetzt */
      --table-sticky-gap: 8px;      /* Abstand unterhalb des Seiten-Headers */
      --table-sticky-top: calc(var(--page-header-height) + var(--table-sticky-gap));
    }
    *{box-sizing:border-box}
    html{scroll-padding-top: calc(var(--page-header-height) + 16px);} /* bessere Anker-/Scroll-Experience */
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; background:linear-gradient(180deg,#0b1023, #0f172a 50%, #0b1023); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:rgba(15,23,42,.85); backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid #1f2937; padding:12px 16px; display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    header h1{font-size:1.1rem; margin:0; letter-spacing:.3px}
    .badge{font-size:.75rem; padding:4px 8px; border:1px solid #374151; border-radius:999px; color:var(--muted)}
    .container{max-width:1200px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns:360px 1fr; gap:16px}
    @media (max-width: 1080px){.container{grid-template-columns:1fr}}
    .card{background:radial-gradient(1200px 300px at 0% 0%,rgba(34,197,94,.08),transparent 70%), radial-gradient(900px 300px at 100% 0%,rgba(59,130,246,.08),transparent 70%), var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px; box-shadow:0 20px 40px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03)}
    .card h2{margin:0 0 10px 0; font-size:1rem; color:#e2e8f0}
    .grid{display:grid; gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    label{font-size:.85rem; color:var(--muted)}
    input[type="text"], input[type="time"], input[type="number"], textarea, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#111827; color:var(--text); outline:none}
    textarea{min-height:120px; resize:vertical; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:8px 12px; border-radius:8px; cursor:pointer; transition:.15s; font-weight:600; font-size:.85rem}
    .btn:hover{transform:translateY(-1px); border-color:#475569}
    .btn.primary{background:linear-gradient(135deg, #22c55e, #16a34a); border-color:transparent; color:#052e16}
    .btn.accent{background:linear-gradient(135deg, #3b82f6, #2563eb); border-color:transparent}
    .btn.warn{background:linear-gradient(135deg, #f59e0b, #d97706); border-color:transparent}
    .btn.ghost{background:transparent; border-color:#334155; color:#cbd5e1}
    .btn.inline{padding:4px 8px; font-size:.8rem}
    .hint{font-size:.8rem; color:var(--muted)}
    .pill{font-size:.75rem; padding:2px 8px; border-radius:999px; border:1px solid #334155}
    .legend{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .dot{width:10px; height:10px; border-radius:50%}
    .A{background:var(--groupA)} .B{background:var(--groupB)} .C{background:var(--groupC)}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid #1f2937}
    thead th{position:sticky; top: var(--table-sticky-top); z-index: 2; background:#0b1226; color:#cbd5e1; font-weight:700; box-shadow:0 2px 0 rgba(0,0,0,.15)}
    th, td{padding:10px 12px; border-bottom:1px solid #1f2937; text-align:left; font-size:.92rem}
    tbody tr:hover{background:#0b12261a}
    .groupTag{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-weight:700; font-size:.8rem}
    .groupTag.A{background:color-mix(in srgb, var(--groupA) 20%, transparent); color:#d1fae5; border:1px solid color-mix(in srgb, var(--groupA) 40%, #000)}
    .groupTag.B{background:color-mix(in srgb, var(--groupB) 20%, transparent); color:#fff7ed; border:1px solid color-mix(in srgb, var(--groupB) 40%, #000)}
    .groupTag.C{background:color-mix(in srgb, var(--groupC) 20%, transparent); color:#eef2ff; border:1px solid color-mix(in srgb, var(--groupC) 40%, #000)}
    .saved{color:#22c55e; font-size:.8rem; margin-left:6px}
    .errorText{color:#ef4444; font-size:.85rem}
    @media print{header, .config, .sticky-actions {display:none !important} body {background:#fff; color:#000} .card {box-shadow:none; border:1px solid #ddd} thead th {position:static; background:#fff; color:#000}}
  </style>
</head>
<body>
  <header>
    <h1>TSV Königsbrunn – Hallenmasters · Nur nächste Runde (CL‑Modus)</h1>
    <span class="badge">Nächste Runde erst nach 3 gespeicherten Ergebnissen</span>
  </header>

  <div class="container">
    <section class="card config" id="config">
      <h2>Turnier-Konfiguration</h2>
      <div class="grid">
        <div class="grid grid-2">
          <div>
            <label for="startTime">Startzeit</label>
            <input type="time" id="startTime" value="10:00">
          </div>
          <div>
            <label for="gameMinutes">Spielzeit (Minuten)</label>
            <input type="number" id="gameMinutes" value="10" min="1" step="1">
          </div>
          <div>
            <label for="breakMinutes">Pausenzeit (Minuten)</label>
            <input type="number" id="breakMinutes" value="2" min="0" step="1">
          </div>
          <div>
            <label for="rotationPattern">Rotationsmuster</label>
            <input type="text" id="rotationPattern" value="A,B,C,A,B,C" />
          </div>
        </div>

        <div class="row">
          <label for="preset" style="min-width:180px">Regel-Preset</label>
          <select id="preset">
            <option value="custom">Eigenes Mapping</option>
            <option value="cl" selected>Champions-League-Modus</option>
          </select>
          <span class="hint">CL‑Modus: F1 = W1 vs W2 · F2 = W3 vs L1 · F3 = L3 vs L2</span>
        </div>

        <div class="grid grid-3">
          <div>
            <label>Gruppe A Teams (je Zeile ein Team)</label>
            <textarea id="teamsA">A1\nA2\nA3\nA4\nA5\nA6</textarea>
          </div>
          <div>
            <label>Gruppe B Teams</label>
            <textarea id="teamsB">B1\nB2\nB3\nB4\nB5\nB6</textarea>
          </div>
          <div>
            <label>Gruppe C Teams</label>
            <textarea id="teamsC">C1\nC2\nC3\nC4\nC5\nC6</textarea>
          </div>
        </div>

        <details class="card" style="background:#0b1226; border-color:#1e293b">
          <summary><strong>Regel-Editor (optional)</strong> – überschreibt das Preset</summary>
          <p class="hint">Rollen: <code>W1,L1,W2,L2,W3,L3</code> aus der <em>vorherigen Runde</em>. Felder: 1–3 der <em>nächsten Runde</em>.</p>
          <div class="grid grid-3">
            <div>
              <h3>Gruppe A</h3>
              <label>Feld 1</label>
              <div class="row"><select id="A_F1_H"></select><select id="A_F1_A"></select></div>
              <label>Feld 2</label>
              <div class="row"><select id="A_F2_H"></select><select id="A_F2_A"></select></div>
              <label>Feld 3</label>
              <div class="row"><select id="A_F3_H"></select><select id="A_F3_A"></select></div>
            </div>
            <div>
              <h3>Gruppe B</h3>
              <label>Feld 1</label>
              <div class="row"><select id="B_F1_H"></select><select id="B_F1_A"></select></div>
              <label>Feld 2</label>
              <div class="row"><select id="B_F2_H"></select><select id="B_F2_A"></select></div>
              <label>Feld 3</label>
              <div class="row"><select id="B_F3_H"></select><select id="B_F3_A"></select></div>
            </div>
            <div>
              <h3>Gruppe C</h3>
              <label>Feld 1</label>
              <div class="row"><select id="C_F1_H"></select><select id="C_F1_A"></select></div>
              <label>Feld 2</label>
              <div class="row"><select id="C_F2_H"></select><select id="C_F2_A"></select></div>
              <label>Feld 3</label>
              <div class="row"><select id="C_F3_H"></select><select id="C_F3_A"></select></div>
            </div>
          </div>
          <p class="errorText" id="rulesError" style="display:none"></p>
        </details>

        <div class="row">
          <button class="btn primary" id="btnGenerate">Slots & Runde 1 anlegen</button>
          <button class="btn" id="btnSave">Einstellungen speichern</button>
          <button class="btn ghost" id="btnLoad">Gespeichertes laden</button>
          <button class="btn warn" id="btnReset">Zurücksetzen</button>
        </div>

        <div class="legend">
          <span class="pill"><span class="dot A"></span> Gruppe A</span>
          <span class="pill"><span class="dot B"></span> Gruppe B</span>
          <span class="pill"><span class="dot C"></span> Gruppe C</span>
          <span class="pill">Felder: 3</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Nur nächste Runde pro Gruppe</h2>
      <div class="hint" style="margin-bottom:8px">Erst wenn <strong>alle 3 Ergebnisse</strong> der aktuellen Runde gespeichert sind, wird die <strong>nächste Runde</strong> gemäß Preset/Regel‑Editor erzeugt.</div>

      <div class="tableWrap">
        <table id="scheduleTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Start</th>
              <th>Ende</th>
              <th>Gruppe</th>
              <th>Runde</th>
              <th>Feld</th>
              <th>Team 1</th>
              <th>Team 2</th>
              <th>Ergebnis</th>
            </tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </div>

      <div class="sticky-actions">
        <button class="btn primary" id="btnRegenerate">Zeitslots neu berechnen</button>
        <button class="btn ghost" id="btnScrollTop">Nach oben</button>
      </div>
    </section>
  </div>

  <div class="footer">TSV Königsbrunn – Hallenmasters · CL‑Modus · © 2025</div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    // Sticky-Header: dynamischen Offset aus Seiten-Header setzen
    function updateStickyTopFromHeader(){
      const h = document.querySelector('header');
      if(!h) return;
      const headerHeight = h.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--page-header-height', headerHeight + 'px');
    }
    window.addEventListener('load', updateStickyTopFromHeader);
    window.addEventListener('resize', updateStickyTopFromHeader);

    const ROLES = ['W1','L1','W2','L2','W3','L3'];

    function parseTeams(text){ return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
    function pad2(n){return String(n).padStart(2,'0')}
    function addMinutes(timeHHMM, minutes){ const [h,m] = timeHHMM.split(':').map(Number); const d = new Date(2000,0,1,h,m,0,0); d.setMinutes(d.getMinutes()+minutes); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

    // --- State (Runden sind 1-basiert gespeichert) ---
    let slots = [];              // [{start,end,group}]
    let slotAssignments = [];    // [{group}]
    let currentRound = {A:1,B:1,C:1};
    let matches = [];            // alle angelegten Matches
    let results = {};            // results[group][round][field] = {g1,g2}

    function seedPairs(teams){ return [[teams[0],teams[1]],[teams[2],teams[3]],[teams[4],teams[5]]].filter(p=>p[0]&&p[1]); }

    function buildSelectOptions(sel){ sel.innerHTML=''; for(const r of ROLES){ const o=document.createElement('option'); o.textContent=r; o.value=r; sel.appendChild(o); } }

    function applyPresetCL(){
      const set = (g,f,h,a)=>{ $(`#${g}_F${f}_H`).value=h; $(`#${g}_F${f}_A`).value=a; };
      for(const g of ['A','B','C']){
        set(g,1,'W1','W2'); // Feld 1: W1 vs W2
        set(g,2,'W3','L1'); // Feld 2: W3 vs L1
        set(g,3,'L3','L2'); // Feld 3: L3 vs L2
      }
    }

    function initRuleEditor(){
      for(const g of ['A','B','C']){
        for(const f of [1,2,3]){
          buildSelectOptions($(`#${g}_F${f}_H`));
          buildSelectOptions($(`#${g}_F${f}_A`));
        }
      }
      applyPresetCL();
    }

    function getRuleMappingFor(group){
      const m = {}; for(const f of [1,2,3]){ m[`Feld ${f}`]=[$(`#${group}_F${f}_H`).value, $(`#${group}_F${f}_A`).value]; }
      return m;
    }

    function computeOutcomesFor(group, round){ // round = abgeschlossene Runde (1-basiert)
      const r = results[group]?.[round]; if(!r) return null;
      const out = {};
      for(let f=1; f<=3; f++){
        const res = r[`Feld ${f}`]; const match = matches.find(m=>m.group===group && m.round===round && m.field===`Feld ${f}`);
        if(!match || !res) return null;
        const {g1,g2} = res; if(!Number.isFinite(g1) || !Number.isFinite(g2)) return null; if(g1===g2) return {draw:true};
        const W = g1>g2 ? match.team1 : match.team2; const L = g1>g2 ? match.team2 : match.team1;
        out[`W${f}`]=W; out[`L${f}`]=L;
      }
      return out;
    }

    function nextPairs(outcomes, mapping){
      const pairs = []; for(let f=1; f<=3; f++){ const refs = mapping[`Feld ${f}`]||[]; const a = outcomes?.[refs[0]]||'TBD'; const b = outcomes?.[refs[1]]||'TBD'; pairs.push([a,b]); }
      return pairs;
    }

    function buildSlotAssignments(startTime, minutesPerSlot, rotationPattern, maxSlots=60){
      const rot = rotationPattern.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean); const assigns=[]; const s=[]; let t=startTime;
      for(let i=0;i<maxSlots;i++){ const g=rot[i % rot.length]; const end=addMinutes(t, minutesPerSlot); assigns.push({group:g}); s.push({start:t,end,group:g}); t=end; }
      return {assigns, slots:s};
    }

    function nthGroupSlotIndex(group, n){ let c=0; for(let i=0;i<slotAssignments.length;i++){ if(slotAssignments[i].group===group){ c++; if(c===n) return i; } } return -1; }

    function addRoundMatches(group, round, pairs){
      const idx = nthGroupSlotIndex(group, round); if(idx<0){ alert(`Zu wenige Slots für Gruppe ${group} Runde ${round}`); return; }
      const slot = slots[idx]; const end = addMinutes(slot.start, parseInt($('#gameMinutes').value,10));
      for(let f=1; f<=3; f++){ const p=pairs[f-1]||['TBD','TBD']; matches.push({ slot: idx+1, start: slot.start, end, group, round, field:`Feld ${f}`, team1:p[0], team2:p[1] }); }
    }

    function collectConfig(){
      const groups = { A: parseTeams($('#teamsA').value), B: parseTeams($('#teamsB').value), C: parseTeams($('#teamsC').value) };
      for(const g of Object.keys(groups)){ if(groups[g].length===0) delete groups[g]; }
      const startTime=$('#startTime').value||'10:00'; const gameMinutes=parseInt($('#gameMinutes').value,10); const breakMinutes=parseInt($('#breakMinutes').value,10); const rotationPattern=$('#rotationPattern').value;
      return {groups,startTime,gameMinutes,breakMinutes,rotationPattern};
    }

    function generateInitial(){
      matches=[]; results={}; currentRound={A:1,B:1,C:1};
      const cfg = collectConfig();
      const minutesPerSlot = cfg.gameMinutes + cfg.breakMinutes;
      const built = buildSlotAssignments(cfg.startTime, minutesPerSlot, cfg.rotationPattern, 60); slotAssignments=built.assigns; slots=built.slots;
      for(const g of Object.keys(cfg.groups)){ const pairs = seedPairs(cfg.groups[g]); addRoundMatches(g, 1, pairs); }
      renderSchedule();
    }

    function allThreeResultsPresent(group, round){ const r=results[group]?.[round]; if(!r) return false; for(let f=1; f<=3; f++){ const rr=r[`Feld ${f}`]; if(!rr || !Number.isFinite(rr.g1) || !Number.isFinite(rr.g2) || rr.g1===rr.g2) return false; } return true; }

    function onResultSaved(group, round){
      if(!allThreeResultsPresent(group, round)) { renderSchedule(); return; }
      const outcomes = computeOutcomesFor(group, round); if(!outcomes || outcomes.draw) { renderSchedule(); return; }
      const mapping = getRuleMappingFor(group); const pairs = nextPairs(outcomes, mapping);
      const nextRound = round+1; addRoundMatches(group, nextRound, pairs); currentRound[group]=nextRound; renderSchedule();
    }

    function getSavedResult(group, round, field){ return results[group]?.[round]?.[field]; }
    function saveResult(group, round, field, g1, g2){ if(!results[group]) results[group]={}; if(!results[group][round]) results[group][round]={}; results[group][round][field]={g1,g2}; onResultSaved(group, round); }

    function renderSchedule(){
      const tbody = $('#scheduleBody'); tbody.innerHTML='';
      const filtered = matches.filter(m => m.round === currentRound[m.group]);
      for(const m of filtered){
        const tr = document.createElement('tr'); const t1=m.team1||'TBD', t2=m.team2||'TBD';
        const saved = getSavedResult(m.group, m.round, m.field); // gespeicherte Werte der AKTUELLEN Runde
        const g1v = (saved && Number.isFinite(saved.g1)) ? saved.g1 : '';
        const g2v = (saved && Number.isFinite(saved.g2)) ? saved.g2 : '';
        tr.innerHTML = `
          <td>${m.slot}</td>
          <td>${m.start}</td>
          <td>${m.end}</td>
          <td><span class="groupTag ${m.group}">${m.group}</span></td>
          <td>${m.round}</td>
          <td>${m.field}</td>
          <td>${t1}</td>
          <td>${t2}</td>
          <td>
            <div class="row" style="gap:6px; align-items:center">
              <input type="number" min="0" placeholder="0" data-key="g1" value="${g1v}" style="width:64px; text-align:center" />
              <span style="opacity:.7">:</span>
              <input type="number" min="0" placeholder="0" data-key="g2" value="${g2v}" style="width:64px; text-align:center" />
              <button class="btn inline" data-action="save">Speichern</button>
              <span class="hint">oder</span>
              <button class="btn inline" data-action="t1win">${t1} siegt</button>
              <button class="btn inline" data-action="t2win">${t2} siegt</button>
              ${saved?'<span class="saved">✓ gespeichert</span>':''}
            </div>
          </td>
        `;
        const inputs = tr.querySelectorAll('input');
        const btnSave = tr.querySelector('button[data-action="save"]');
        const btnT1 = tr.querySelector('button[data-action="t1win"]');
        const btnT2 = tr.querySelector('button[data-action="t2win"]');
        const commit = (a,b)=>{ if(!Number.isFinite(a) || !Number.isFinite(b)){ alert('Bitte gültige Tore eingeben.'); return; } saveResult(m.group, m.round, m.field, a, b); };
        btnSave.addEventListener('click', ()=>{ const g1=parseInt(inputs[0].value,10); const g2=parseInt(inputs[1].value,10); commit(g1,g2); });
        btnT1.addEventListener('click', ()=>commit(1,0));
        btnT2.addEventListener('click', ()=>commit(0,1));
        tbody.appendChild(tr);
      }
    }

    function saveConfig(){
      const cfg = collectConfig();
      const mapping={A:getRuleMappingFor('A'),B:getRuleMappingFor('B'),C:getRuleMappingFor('C')};
      localStorage.setItem('funino_cfg_v5', JSON.stringify({...cfg, mapping, preset:$('#preset').value}));
      localStorage.setItem('funino_state_v5', JSON.stringify({results,matches,currentRound}));
    }
    function loadConfig(){
      const raw=localStorage.getItem('funino_cfg_v5');
      const rawS=localStorage.getItem('funino_state_v5');
      if(raw){
        try{
          const cfg=JSON.parse(raw);
          if(cfg.startTime) $('#startTime').value=cfg.startTime;
          if(cfg.gameMinutes) $('#gameMinutes').value=cfg.gameMinutes;
          if(cfg.breakMinutes!==undefined) $('#breakMinutes').value=cfg.breakMinutes;
          if(cfg.rotationPattern) $('#rotationPattern').value=cfg.rotationPattern;
          if(cfg.groups?.A) $('#teamsA').value=cfg.groups.A.join("\n");
          if(cfg.groups?.B) $('#teamsB').value=cfg.groups.B.join("\n");
          if(cfg.groups?.C) $('#teamsC').value=cfg.groups.C.join("\n");
          $('#preset').value = cfg.preset||'cl';
          for(const g of ['A','B','C']){
            for(const f of [1,2,3]){
              const ids=[`${g}_F${f}_H`,`${g}_F${f}_A`];
              for(const id of ids){ const el=document.getElementById(id); if(cfg.mapping?.[g] && cfg.mapping[g][`Feld ${f}`]){ el.value = cfg.mapping[g][`Feld ${f}`][id.endsWith('_H')?0:1]; } }
            }
          }
        }catch(e){ console.warn('Konfiguration laden fehlgeschlagen', e); }
      }
      if(rawS){
        try{
          const s=JSON.parse(rawS);
          results=s.results||{}; matches=s.matches||[]; currentRound=s.currentRound||{A:1,B:1,C:1};
        }catch(e){ console.warn('State laden fehlgeschlagen', e); }
      }
    }

    function resetAll(){ localStorage.removeItem('funino_cfg_v5'); localStorage.removeItem('funino_state_v5'); window.location.reload(); }

    $('#btnGenerate').addEventListener('click', ()=>{ generateInitial(); });
    $('#btnRegenerate').addEventListener('click', ()=>{ const cfg=collectConfig(); const minutesPerSlot=cfg.gameMinutes+cfg.breakMinutes; const built=buildSlotAssignments(cfg.startTime, minutesPerSlot, cfg.rotationPattern, 60); slotAssignments=built.assigns; slots=built.slots; renderSchedule(); });
    $('#btnSave').addEventListener('click', ()=>{ saveConfig(); });
    $('#btnLoad').addEventListener('click', ()=>{ loadConfig(); renderSchedule(); alert('Geladen (falls vorhanden)'); });
    $('#btnReset').addEventListener('click', ()=>{ if(confirm('Alles zurücksetzen?')) resetAll(); });

    $('#preset').addEventListener('change', ()=>{ if($('#preset').value==='cl'){ applyPresetCL(); } });

    // Init
    initRuleEditor();
    loadConfig();
    if(matches.length===0){ try{ generateInitial(); }catch(e){ console.warn(e); } }
    renderSchedule();
  </script>
</body>
</html>