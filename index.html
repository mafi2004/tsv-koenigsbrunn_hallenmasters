<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSV Königsbrunn – Hallenmasters | Funino Spielplan (dynamisch)</title>
  <meta name="description" content="Dynamisch anpassbarer Funino-Spielplan mit Ergebnis-Erfassung und feldübergreifenden Auf-/Abstiegsregeln." />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent-2:#3b82f6; --warn:#f59e0b; --error:#ef4444;
      --groupA:#10b981; --groupB:#f97316; --groupC:#6366f1;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; background:linear-gradient(180deg,#0b1023, #0f172a 50%, #0b1023); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:rgba(15,23,42,.8); backdrop-filter:saturate(120%) blur(6px); border-bottom:1px solid #1f2937; padding:12px 16px; display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    header h1{font-size:1.1rem; margin:0; letter-spacing:.3px}
    .badge{font-size:.75rem; padding:4px 8px; border:1px solid #374151; border-radius:999px; color:var(--muted)}
    .container{max-width:1200px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns:360px 1fr; gap:16px}
    @media (max-width: 1080px){.container{grid-template-columns:1fr}}
    .card{background:radial-gradient(1200px 300px at 0% 0%,rgba(34,197,94,.08),transparent 70%), radial-gradient(900px 300px at 100% 0%,rgba(59,130,246,.08),transparent 70%), var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px; box-shadow:0 20px 40px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03)}
    .card h2{margin:0 0 10px 0; font-size:1rem; color:#e2e8f0}
    .grid{display:grid; gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    label{font-size:.85rem; color:var(--muted)}
    input[type="text"], input[type="time"], input[type="number"], textarea, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#111827; color:var(--text); outline:none}
    textarea{min-height:120px; resize:vertical; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:10px 14px; border-radius:10px; cursor:pointer; transition:.15s; font-weight:600}
    .btn:hover{transform:translateY(-1px); border-color:#475569}
    .btn.primary{background:linear-gradient(135deg, #22c55e, #16a34a); border-color:transparent; color:#052e16}
    .btn.accent{background:linear-gradient(135deg, #3b82f6, #2563eb); border-color:transparent}
    .btn.warn{background:linear-gradient(135deg, #f59e0b, #d97706); border-color:transparent}
    .btn.ghost{background:transparent; border-color:#334155; color:#cbd5e1}
    .hint{font-size:.8rem; color:var(--muted)}
    .pill{font-size:.75rem; padding:2px 8px; border-radius:999px; border:1px solid #334155}
    .legend{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .dot{width:10px; height:10px; border-radius:50%}
    .A{background:var(--groupA)} .B{background:var(--groupB)} .C{background:var(--groupC)}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid #1f2937}
    thead th{position:sticky; top:63px; background:#0b1226; color:#cbd5e1; font-weight:700}
    th, td{padding:10px 12px; border-bottom:1px solid #1f2937; text-align:left; font-size:.92rem}
    tbody tr:hover{background:#0b12261a}
    .groupTag{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-weight:700; font-size:.8rem}
    .groupTag.A{background:color-mix(in srgb, var(--groupA) 20%, transparent); color:#d1fae5; border:1px solid color-mix(in srgb, var(--groupA) 40%, #000)}
    .groupTag.B{background:color-mix(in srgb, var(--groupB) 20%, transparent); color:#fff7ed; border:1px solid color-mix(in srgb, var(--groupB) 40%, #000)}
    .groupTag.C{background:color-mix(in srgb, var(--groupC) 20%, transparent); color:#eef2ff; border:1px solid color-mix(in srgb, var(--groupC) 40%, #000)}
    .footer{color:#94a3b8; font-size:.8rem; text-align:center; margin:24px 0}
    .sticky-actions{position:sticky; bottom:0; background:rgba(15,23,42,.85); backdrop-filter:blur(6px); padding:10px; border-top:1px solid #1f2937; display:flex; gap:8px; justify-content:flex-end}
    .scoreInputs{display:flex; gap:6px; align-items:center}
    .scoreInputs input{width:60px; text-align:center}
    .tbd{color:#f59e0b; font-style:italic}
    .errorText{color:#ef4444; font-size:.85rem}
    @media print{header, .config, .sticky-actions {display:none !important} body {background:#fff; color:#000} .card {box-shadow:none; border:1px solid #ddd} thead th {position:static; background:#fff; color:#000}}
  </style>
</head>
<body>
  <header>
    <h1>TSV Königsbrunn – Hallenmasters · Dynamischer Funino Spielplan</h1>
    <span class="badge">Ergebnis-abhängige Feldrotation</span>
    <span class="badge">3 Felder · 3 Gruppen × 6 Teams</span>
  </header>

  <div class="container">
    <!-- Konfiguration -->
    <section class="card config" id="config">
      <h2>Turnier-Konfiguration</h2>
      <div class="grid">
        <div class="grid grid-2">
          <div>
            <label for="startTime">Startzeit</label>
            <input type="time" id="startTime" value="10:00">
          </div>
          <div>
            <label for="gameMinutes">Spielzeit (Minuten)</label>
            <input type="number" id="gameMinutes" value="10" min="1" step="1">
          </div>
          <div>
            <label for="breakMinutes">Pausenzeit (Minuten)</label>
            <input type="number" id="breakMinutes" value="2" min="0" step="1">
          </div>
          <div>
            <label for="fieldsCount">Felder</label>
            <input type="number" id="fieldsCount" value="3" min="1" max="3">
          </div>
        </div>

        <div>
          <label for="rotationPattern">Gruppen-Rotationsmuster (Komma-getrennt)</label>
          <input type="text" id="rotationPattern" value="A,B,C,A,B,C" />
          <div class="hint">Definiert, welche Gruppe in welchem Zeitslot spielt. Beispiel: <code>A,B,C</code> → A, dann B, dann C, wiederholen.</div>
        </div>

        <div class="grid grid-3">
          <div>
            <label>Gruppe A Teams (je Zeile ein Team)</label>
            <textarea id="teamsA">A1\nA2\nA3\nA4\nA5\nA6</textarea>
          </div>
          <div>
            <label>Gruppe B Teams</label>
            <textarea id="teamsB">B1\nB2\nB3\nB4\nB5\nB6</textarea>
          </div>
          <div>
            <label>Gruppe C Teams</label>
            <textarea id="teamsC">C1\nC2\nC3\nC4\nC5\nC6</textarea>
          </div>
        </div>

        <details class="card" style="background:#0b1226; border-color:#1e293b">
          <summary><strong>Regeln für Ergebnis-abhängige Paarungen</strong> (pro Gruppe anpassbar)</summary>
          <p class="hint">Definiere, welche Teams aus der <em>vorherigen Runde</em> in der <em>nächsten Runde</em> auf welchem Feld spielen. Bezeichner: <code>W1,L1,W2,L2,W3,L3</code> → Sieger/Verlierer von Feld 1/2/3.</p>
          <div class="grid grid-3">
            <div>
              <h3>Gruppe A</h3>
              <label>Feld 1</label>
              <div class="row">
                <select id="A_F1_H">
                  <option>W1</option>
                  <option>L1</option>
                  <option>W2</option>
                  <option>L2</option>
                  <option>W3</option>
                  <option>L3</option>
                </select>
                <select id="A_F1_A">
                  <option>W1</option>
                  <option selected>L2</option>
                  <option>W2</option>
                  <option>L1</option>
                  <option>W3</option>
                  <option>L3</option>
                </select>
              </div>
              <label>Feld 2</label>
              <div class="row">
                <select id="A_F2_H">
                  <option selected>W3</option>
                  <option>W1</option>
                  <option>L1</option>
                  <option>W2</option>
                  <option>L2</option>
                  <option>L3</option>
                </select>
                <select id="A_F2_A">
                  <option selected>L1</option>
                  <option>W1</option>
                  <option>W2</option>
                  <option>L2</option>
                  <option>W3</option>
                  <option>L3</option>
                </select>
              </div>
              <label>Feld 3</label>
              <div class="row">
                <select id="A_F3_H">
                  <option selected>L3</option>
                  <option>W1</option>
                  <option>L1</option>
                  <option>W2</option>
                  <option>L2</option>
                  <option>W3</option>
                </select>
                <select id="A_F3_A">
                  <option selected>W2</option>
                  <option>W1</option>
                  <option>L1</option>
                  <option>L2</option>
                  <option>W3</option>
                  <option>L3</option>
                </select>
              </div>
              <div class="hint">Voreinstellung spiegelt deine Vorgabe: W3→F2 gegen L1, W1 bleibt (F1), L3 bleibt (F3). Gegner sind L2 bzw. W2.</div>
            </div>
            <div>
              <h3>Gruppe B</h3>
              <label>Feld 1</label>
              <div class="row"><select id="B_F1_H"><option selected>W1</option><option>L1</option><option>W2</option><option>L2</option><option>W3</option><option>L3</option></select><select id="B_F1_A"><option selected>L2</option><option>W1</option><option>W2</option><option>L1</option><option>W3</option><option>L3</option></select></div>
              <label>Feld 2</label>
              <div class="row"><select id="B_F2_H"><option selected>W3</option><option>W1</option><option>L1</option><option>W2</option><option>L2</option><option>L3</option></select><select id="B_F2_A"><option selected>L1</option><option>W1</option><option>W2</option><option>L2</option><option>W3</option><option>L3</option></select></div>
              <label>Feld 3</label>
              <div class="row"><select id="B_F3_H"><option selected>L3</option><option>W1</option><option>L1</option><option>W2</option><option>L2</option><option>W3</option></select><select id="B_F3_A"><option selected>W2</option><option>W1</option><option>L1</option><option>L2</option><option>W3</option><option>L3</option></select></div>
            </div>
            <div>
              <h3>Gruppe C</h3>
              <label>Feld 1</label>
              <div class="row"><select id="C_F1_H"><option selected>W1</option><option>L1</option><option>W2</option><option>L2</option><option>W3</option><option>L3</option></select><select id="C_F1_A"><option selected>L2</option><option>W1</option><option>W2</option><option>L1</option><option>W3</option><option>L3</option></select></div>
              <label>Feld 2</label>
              <div class="row"><select id="C_F2_H"><option selected>W3</option><option>W1</option><option>L1</option><option>W2</option><option>L2</option><option>L3</option></select><select id="C_F2_A"><option selected>L1</option><option>W1</option><option>W2</option><option>L2</option><option>W3</option><option>L3</option></select></div>
              <label>Feld 3</label>
              <div class="row"><select id="C_F3_H"><option selected>L3</option><option>W1</option><option>L1</option><option>W2</option><option>L2</option><option>W3</option></select><select id="C_F3_A"><option selected>W2</option><option>W1</option><option>L1</option><option>L2</option><option>W3</option><option>L3</option></select></div>
            </div>
          </div>
          <p class="errorText" id="rulesError" style="display:none"></p>
        </details>

        <div class="row">
          <button class="btn primary" id="btnGenerate">Slots & Runde 1 anlegen</button>
          <button class="btn" id="btnSave">Einstellungen speichern</button>
          <button class="btn ghost" id="btnLoad">Gespeichertes laden</button>
          <button class="btn warn" id="btnReset">Zurücksetzen</button>
        </div>

        <div class="legend">
          <span class="pill"><span class="dot A"></span> Gruppe A</span>
          <span class="pill"><span class="dot B"></span> Gruppe B</span>
          <span class="pill"><span class="dot C"></span> Gruppe C</span>
          <span class="pill">Felder: 3</span>
        </div>
      </div>
    </section>

    <!-- Spielplan & Ergebnis-Erfassung -->
    <section class="card">
      <h2>Spielplan & Ergebnisse</h2>
      <div class="row" style="justify-content:space-between; gap:8px; margin-bottom:8px">
        <div class="row">
          <label>Filter:&nbsp;</label>
          <select id="filterGroup"><option value="">Alle Gruppen</option><option value="A">Gruppe A</option><option value="B">Gruppe B</option><option value="C">Gruppe C</option></select>
          <select id="filterField"><option value="">Alle Felder</option><option value="Feld 1">Feld 1</option><option value="Feld 2">Feld 2</option><option value="Feld 3">Feld 3</option></select>
          <input type="text" id="filterTeam" placeholder="Team suchen (z. B. A3)" />
        </div>
        <div class="row">
          <button class="btn" id="btnExportCSV">CSV exportieren</button>
          <button class="btn" id="btnExportJSON">JSON exportieren</button>
          <button class="btn accent" onclick="window.print()">Drucken/PDF</button>
        </div>
      </div>

      <div class="hint" style="margin-bottom:8px">Gib die Ergebnisse ein und klicke "Speichern" pro Spiel. Die <strong>nächste Runde</strong> wird für die betreffende Gruppe automatisch berechnet.</div>

      <div class="tableWrap">
        <table id="scheduleTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Start</th>
              <th>Ende</th>
              <th>Gruppe</th>
              <th>Runde</th>
              <th>Feld</th>
              <th>Team 1</th>
              <th>Team 2</th>
              <th>Ergebnis</th>
            </tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </div>

      <div class="sticky-actions">
        <button class="btn primary" id="btnRegenerate">Zeit-Slots neu berechnen</button>
        <button class="btn ghost" id="btnScrollTop">Nach oben</button>
      </div>
    </section>
  </div>

  <div class="footer">TSV Königsbrunn – Hallenmasters · Dynamischer Spielplan · © 2025</div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    function parseTeams(text){ return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
    function pad2(n){return String(n).padStart(2,'0')}
    function addMinutes(timeHHMM, minutes){ const [h,m] = timeHHMM.split(':').map(Number); const d = new Date(2000,0,1,h,m,0,0); d.setMinutes(d.getMinutes()+minutes); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

    // State
    let currentSchedule = []; // array of matches across slots
    let results = {}; // results[group][round][field] = {g1,g2}

    function seedPairs(teams, fieldsCount){
      const pairs = [];
      for(let f=0; f<fieldsCount; f++){
        const i = f*2;
        if(teams[i] && teams[i+1]) pairs.push([teams[i], teams[i+1]]);
      }
      return pairs; // length <= fieldsCount
    }

    function computePrevRoundOutcomes(group, round){
      const r = results[group]?.[round];
      if(!r) return null;
      const out = {};
      for(let f=1; f<=3; f++){
        const res = r[`Feld ${f}`];
        const match = currentSchedule.find(m => m.group===group && m.round===round+1 && m.field===`Feld ${f}`);
        if(!match || !res) return null; // incomplete
        const {g1,g2} = res;
        if(g1===undefined || g2===undefined) return null;
        let W = match.team1, L = match.team2;
        if(g2>g1){ W = match.team2; L = match.team1; }
        else if(g2===g1){
          // Draw: cannot decide automatically
          return {draw:true};
        }
        out[`W${f}`]=W; out[`L${f}`]=L;
      }
      return out;
    }

    function getRuleMappingFor(group){
      function val(id){ return document.getElementById(id).value; }
      const m = {};
      if(group==='A'){
        m['Feld 1'] = [val('A_F1_H'), val('A_F1_A')];
        m['Feld 2'] = [val('A_F2_H'), val('A_F2_A')];
        m['Feld 3'] = [val('A_F3_H'), val('A_F3_A')];
      }else if(group==='B'){
        m['Feld 1'] = [val('B_F1_H'), val('B_F1_A')];
        m['Feld 2'] = [val('B_F2_H'), val('B_F2_A')];
        m['Feld 3'] = [val('B_F3_H'), val('B_F3_A')];
      }else if(group==='C'){
        m['Feld 1'] = [val('C_F1_H'), val('C_F1_A')];
        m['Feld 2'] = [val('C_F2_H'), val('C_F2_A')];
        m['Feld 3'] = [val('C_F3_H'), val('C_F3_A')];
      }
      return m;
    }

    function nextRoundPairsFromOutcomes(outcomes, mapping){
      // mapping: { 'Feld 1': ['W1','L2'], 'Feld 2':['W3','L1'], 'Feld 3':['L3','W2'] }
      const pairs = [];
      for(let f=1; f<=3; f++){
        const refs = mapping[`Feld ${f}`];
        if(!refs){ pairs.push(['TBD','TBD']); continue; }
        const a = outcomes[refs[0]]; const b = outcomes[refs[1]];
        pairs.push([a||'TBD', b||'TBD']);
      }
      return pairs;
    }

    function roundRobin(teams){ // fallback, if needed
      const n = teams.length; if(n % 2 !== 0){ teams = [...teams, 'FREI']; }
      const arr = [...teams]; const half = arr.length / 2; const rounds = [];
      for(let r=0;r<arr.length-1;r++){
        const left = arr.slice(0, half); const right = arr.slice(half).reverse();
        const pairs = []; for(let i=0;i<left.length;i++){ if(left[i] !== 'FREI' && right[i] !== 'FREI'){ pairs.push([left[i], right[i]]); } }
        rounds.push(pairs);
        const fixed = arr[0]; const moved = arr.splice(1); moved.unshift(moved.pop()); arr.splice(1, 0, ...moved); arr[0] = fixed;
      }
      return rounds;
    }

    function buildTimeSlots(start, minutesPerSlot, count){
      const slots = []; let t = start; for(let i=0;i<count;i++){ const end = addMinutes(t, minutesPerSlot); slots.push({start:t, end}); t = addMinutes(end, 0); } return slots; }

    function collectConfig(){
      const groups = { A: parseTeams($('#teamsA').value), B: parseTeams($('#teamsB').value), C: parseTeams($('#teamsC').value) };
      const startTime = $('#startTime').value || '10:00';
      const gameMinutes = parseInt($('#gameMinutes').value, 10);
      const breakMinutes = parseInt($('#breakMinutes').value, 10);
      const fieldsCount = parseInt($('#fieldsCount').value, 10);
      const rotationPattern = $('#rotationPattern').value;
      for(const g of Object.keys(groups)){ if(groups[g].length === 0) delete groups[g]; }
      const rules = { A: getRuleMappingFor('A'), B: getRuleMappingFor('B'), C: getRuleMappingFor('C') };
      return { groups, startTime, gameMinutes, breakMinutes, fieldsCount, rotationPattern, rules };
    }

    function generateDynamicSchedule(cfg){
      const { groups, fieldsCount, startTime, gameMinutes, breakMinutes, rotationPattern } = cfg;
      const rot = rotationPattern.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
      const roundsNeeded = {}; // we don't predefine; we build as far as results allow, but we create slots for max 6 rounds
      for(const g of Object.keys(groups)){ roundsNeeded[g] = 6; } // heuristic; adjust in UI if needed

      const slotAssignments = []; let guard = 10000;
      while(Object.keys(roundsNeeded).some(g=>roundsNeeded[g]>0) && guard-- > 0){
        for(const g of rot){ if(roundsNeeded[g]>0){ slotAssignments.push({group:g}); roundsNeeded[g]--; } }
        if(slotAssignments.length>60) break; // safety
      }

      const minutesPerSlot = cfg.gameMinutes + cfg.breakMinutes;
      const slots = buildTimeSlots(startTime, minutesPerSlot, slotAssignments.length);

      // Build schedule iteratively per group's round
      const roundIndexPerGroup = {A:0,B:0,C:0};
      const schedule = [];
      const seedPairsPerGroup = {};
      for(const g of Object.keys(groups)){ seedPairsPerGroup[g] = seedPairs(groups[g], fieldsCount); }

      for(let i=0;i<slotAssignments.length;i++){
        const {group} = slotAssignments[i];
        const round = roundIndexPerGroup[group]; // 0-based
        const start = slots[i].start; const end = addMinutes(start, gameMinutes);
        let pairs;
        if(round===0){ pairs = seedPairsPerGroup[group]; }
        else{
          const outcomes = computePrevRoundOutcomes(group, round-1);
          const mapping = cfg.rules[group];
          if(!outcomes){ pairs = [['TBD','TBD'],['TBD','TBD'],['TBD','TBD']]; }
          else if(outcomes.draw){ pairs = [['TBD','TBD'],['TBD','TBD'],['TBD','TBD']]; }
          else { pairs = nextRoundPairsFromOutcomes(outcomes, mapping); }
        }
        for(let f=0; f<fieldsCount; f++){
          const pair = pairs[f]; if(!pair) continue;
          schedule.push({ slot: i+1, start, end, group, round: round+1, field: `Feld ${f+1}`, team1: pair[0], team2: pair[1] });
        }
        roundIndexPerGroup[group]++;
      }
      return schedule;
    }

    function renderSchedule(){
      const tbody = $('#scheduleBody');
      tbody.innerHTML = '';
      const fg = $('#filterGroup').value.toUpperCase();
      const ff = $('#filterField').value;
      const ft = $('#filterTeam').value.trim().toLowerCase();

      const filtered = currentSchedule.filter(m => {
        if(fg && m.group !== fg) return false;
        if(ff && m.field !== ff) return false;
        if(ft){ const hay = `${m.team1} ${m.team2} ${m.field} ${m.group}`.toLowerCase(); if(!hay.includes(ft)) return false; }
        return true;
      });

      for(const m of filtered){
        const tr = document.createElement('tr');
        const t1 = m.team1 || 'TBD'; const t2 = m.team2 || 'TBD';
        tr.innerHTML = `
          <td>${m.slot}</td>
          <td>${m.start}</td>
          <td>${m.end}</td>
          <td><span class="groupTag ${m.group}">${m.group}</span></td>
          <td>${m.round}</td>
          <td>${m.field}</td>
          <td>${t1}</td>
          <td>${t2}</td>
          <td>
            <div class="scoreInputs">
              <input type="number" min="0" placeholder="0" data-key="g1" />
              <span style="opacity:.7">:</span>
              <input type="number" min="0" placeholder="0" data-key="g2" />
              <button class="btn" data-action="save">Speichern</button>
            </div>
            <div class="hint">Ergebnisse für <strong>${m.group} Runde ${m.round}</strong> ${m.field}</div>
          </td>
        `;
        const inputs = tr.querySelectorAll('input');
        const btnSave = tr.querySelector('button[data-action="save"]');
        btnSave.addEventListener('click', ()=>{
          const g1 = parseInt(inputs[0].value,10); const g2 = parseInt(inputs[1].value,10);
          if(Number.isNaN(g1) || Number.isNaN(g2)){ alert('Bitte beide Tore eingeben.'); return; }
          if(!results[m.group]) results[m.group] = {};
          if(!results[m.group][m.round-1]) results[m.group][m.round-1] = {};
          results[m.group][m.round-1][m.field] = {g1, g2};
          // Recompute from next slot onward
          const cfg = collectConfig();
          currentSchedule = generateDynamicSchedule(cfg);
          renderSchedule();
        });
        tbody.appendChild(tr);
      }
    }

    function exportCSV(rows){
      const header = ["Slot","Start","Ende","Gruppe","Runde","Feld","Team1","Team2"]; const lines = [header.join(";")];
      for(const m of rows){ lines.push([m.slot,m.start,m.end,m.group,m.round,m.field,m.team1||'TBD',m.team2||'TBD'].join(";")); }
      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "spielplan.csv"; a.click(); URL.revokeObjectURL(url);
    }
    function exportJSON(rows){
      const blob = new Blob([JSON.stringify(rows,null,2)], {type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "spielplan.json"; a.click(); URL.revokeObjectURL(url);
    }

    function saveConfig(){ const cfg = collectConfig(); localStorage.setItem("funino_cfg_v2", JSON.stringify(cfg)); localStorage.setItem("funino_results_v2", JSON.stringify(results)); }
    function loadConfig(){ const raw = localStorage.getItem("funino_cfg_v2"); const rawR = localStorage.getItem("funino_results_v2"); if(raw){ try{ const cfg = JSON.parse(raw);
        if(cfg.startTime) $('#startTime').value = cfg.startTime; if(cfg.gameMinutes) $('#gameMinutes').value = cfg.gameMinutes; if(cfg.breakMinutes!==undefined) $('#breakMinutes').value = cfg.breakMinutes; if(cfg.fieldsCount) $('#fieldsCount').value = cfg.fieldsCount; if(cfg.rotationPattern) $('#rotationPattern').value = cfg.rotationPattern; if(cfg.groups?.A) $('#teamsA').value = cfg.groups.A.join("\n"); if(cfg.groups?.B) $('#teamsB').value = cfg.groups.B.join("\n"); if(cfg.groups?.C) $('#teamsC').value = cfg.groups.C.join("\n");
        // rules
        const setVal=(id,val)=>{ const el=document.getElementById(id); if(el && val) el.value=val; };
        const r=cfg.rules||{}; const GA=r.A||{}; const GB=r.B||{}; const GC=r.C||{};
        setVal('A_F1_H', GA['Feld 1']?.[0]); setVal('A_F1_A', GA['Feld 1']?.[1]); setVal('A_F2_H', GA['Feld 2']?.[0]); setVal('A_F2_A', GA['Feld 2']?.[1]); setVal('A_F3_H', GA['Feld 3']?.[0]); setVal('A_F3_A', GA['Feld 3']?.[1]);
        setVal('B_F1_H', GB['Feld 1']?.[0]); setVal('B_F1_A', GB['Feld 1']?.[1]); setVal('B_F2_H', GB['Feld 2']?.[0]); setVal('B_F2_A', GB['Feld 2']?.[1]); setVal('B_F3_H', GB['Feld 3']?.[0]); setVal('B_F3_A', GB['Feld 3']?.[1]);
        setVal('C_F1_H', GC['Feld 1']?.[0]); setVal('C_F1_A', GC['Feld 1']?.[1]); setVal('C_F2_H', GC['Feld 2']?.[0]); setVal('C_F2_A', GC['Feld 2']?.[1]); setVal('C_F3_H', GC['Feld 3']?.[0]); setVal('C_F3_A', GC['Feld 3']?.[1]);
      }catch(e){ console.warn('Konnte Konfiguration nicht laden:', e); } }
      if(rawR){ try{ results = JSON.parse(rawR); }catch(e){ results = {}; } }
    }
    function resetAll(){ localStorage.removeItem("funino_cfg_v2"); localStorage.removeItem("funino_results_v2"); window.location.reload(); }

    $('#btnGenerate').addEventListener('click', ()=>{ try{ const cfg = collectConfig(); currentSchedule = generateDynamicSchedule(cfg); renderSchedule(); }catch(e){ alert('Fehler beim Generieren: ' + e.message); } });
    $('#btnRegenerate').addEventListener('click', ()=>{ const cfg = collectConfig(); currentSchedule = generateDynamicSchedule(cfg); renderSchedule(); });
    $('#btnSave').addEventListener('click', ()=>{ saveConfig(); });
    $('#btnLoad').addEventListener('click', ()=>{ loadConfig(); alert('Geladen (falls vorhanden)'); });
    $('#btnReset').addEventListener('click', ()=>{ if(confirm('Alles zurücksetzen?')) resetAll(); });

    $('#filterGroup').addEventListener('change', renderSchedule);
    $('#filterField').addEventListener('change', renderSchedule);
    $('#filterTeam').addEventListener('input', renderSchedule);
    $('#btnExportCSV').addEventListener('click', ()=>exportCSV(currentSchedule));
    $('#btnExportJSON').addEventListener('click', ()=>exportJSON(currentSchedule));
    $('#btnScrollTop').addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));

    // Init
    loadConfig();
    (function initial(){ try{ const cfg = collectConfig(); currentSchedule = generateDynamicSchedule(cfg); renderSchedule(); }catch(e){ console.warn(e); } })();
  </script>
</body>
</html>