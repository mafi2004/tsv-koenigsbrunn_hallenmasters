<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSV Königsbrunn – Hallenmasters | Admin</title>
  <meta name="description" content="Admin-Dashboard: Konfiguration, Ergebnisse und Veröffentlichung des Zuschauerlinks (Read-Only)." />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent-2:#3b82f6; --warn:#f59e0b; --error:#ef4444;
      --groupA:#10b981; --groupB:#f97316; --groupC:#6366f1;
      --page-header-height: 64px;   /* Sticky header fallback */
      --table-sticky-gap: 8px;
      --table-sticky-top: calc(var(--page-header-height) + var(--table-sticky-gap));
    }
    *{box-sizing:border-box}
    html{scroll-padding-top: calc(var(--page-header-height) + 16px);} 
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; background:#0f172a; color:var(--text)}
    header{position:sticky; top:0; z-index:20; background:rgba(15,23,42,.9); backdrop-filter:blur(6px); border-bottom:1px solid #1f2937; padding:12px 16px; display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    header h1{font-size:1.1rem; margin:0; letter-spacing:.3px}
    .badge{font-size:.75rem; padding:4px 8px; border:1px solid #374151; border-radius:999px; color:#cbd5e1}
    .container{max-width:1200px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns:380px 1fr; gap:16px}
    @media (max-width: 1080px){.container{grid-template-columns:1fr}}
    .card{background:radial-gradient(1200px 300px at 0% 0%,rgba(34,197,94,.08),transparent 70%), radial-gradient(900px 300px at 100% 0%,rgba(59,130,246,.08),transparent 70%), #111827; border:1px solid #1f2937; border-radius:12px; padding:16px}
    .card h2{margin:0 0 10px 0; font-size:1rem; color:#e2e8f0}
    .grid{display:grid; gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    label{font-size:.85rem; color:#cbd5e1}
    input[type="text"], input[type="time"], input[type="number"], textarea, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0b1226; color:var(--text); outline:none}
    textarea{min-height:120px; resize:vertical; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{background:#1f2937; color:#e5e7eb; border:1px solid #374151; padding:8px 12px; border-radius:8px; cursor:pointer; transition:.15s; font-weight:600; font-size:.85rem}
    .btn:hover{transform:translateY(-1px); border-color:#475569}
    .btn.primary{background:linear-gradient(135deg, #22c55e, #16a34a); border-color:transparent; color:#052e16}
    .btn.accent{background:linear-gradient(135deg, #3b82f6, #2563eb); border-color:transparent}
    .btn.warn{background:linear-gradient(135deg, #f59e0b, #d97706); border-color:transparent}
    .btn.ghost{background:transparent; border-color:#334155; color:#cbd5e1}
    .hint{font-size:.8rem; color:#94a3b8}
    .pill{font-size:.75rem; padding:2px 8px; border-radius:999px; border:1px solid #334155}
    .dot{width:10px; height:10px; border-radius:50%}
    .A{background:var(--groupA)} .B{background:var(--groupB)} .C{background:var(--groupC)}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid #1f2937}
    thead th{position:sticky; top: var(--table-sticky-top); z-index: 10; background:#0b1226; color:#cbd5e1; font-weight:700; box-shadow:0 2px 0 rgba(0,0,0,.15)}
    th, td{padding:10px 12px; border-bottom:1px solid #1f2937; text-align:left; font-size:.92rem}
    tbody tr:hover{background:#0b12261a}
    .groupTag{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-weight:700; font-size:.8rem}
    .groupTag.A{background:color-mix(in srgb, var(--groupA) 20%, transparent); border:1px solid color-mix(in srgb, var(--groupA) 40%, #000)}
    .groupTag.B{background:color-mix(in srgb, var(--groupB) 20%, transparent); border:1px solid color-mix(in srgb, var(--groupB) 40%, #000)}
    .groupTag.C{background:color-mix(in srgb, var(--groupC) 20%, transparent); border:1px solid color-mix(in srgb, var(--groupC) 40%, #000)}
    .saved{color:#22c55e; font-size:.8rem; margin-left:6px}
    .footer{color:#94a3b8; font-size:.8rem; text-align:center; margin:24px 0}
  </style>
</head>
<body>
  <header>
    <h1>TSV Königsbrunn – Hallenmasters · Admin</h1>
    <span class="badge">Konfiguration · Ergebnisse · Veröffentlichung</span>
    <a class="badge" href="viewer.html" target="_blank" style="text-decoration:none">Zuschauer-Ansicht öffnen</a>
  </header>

  <div class="container">
    <section class="card" id="config">
      <h2>Turnier-Konfiguration</h2>
      <div class="grid">
        <div class="grid grid-2">
          <div>
            <label for="title">Turniertitel</label>
            <input type="text" id="title" value="TSV Königsbrunn – Hallenmasters">
          </div>
          <div>
            <label for="startTime">Startzeit</label>
            <input type="time" id="startTime" value="10:00">
          </div>
          <div>
            <label for="gameMinutes">Spielzeit (Minuten)</label>
            <input type="number" id="gameMinutes" value="10" min="1" step="1">
          </div>
          <div>
            <label for="breakMinutes">Pausenzeit (Minuten)</label>
            <input type="number" id="breakMinutes" value="2" min="0" step="1">
          </div>
          <div>
            <label for="rotationPattern">Rotationsmuster</label>
            <input type="text" id="rotationPattern" value="A,B,C,A,B,C" />
          </div>
        </div>
        <div class="grid grid-3">
          <div>
            <label>Gruppe A (je Zeile ein Team)</label>
            <textarea id="teamsA">A1\nA2\nA3\nA4\nA5\nA6</textarea>
          </div>
          <div>
            <label>Gruppe B</label>
            <textarea id="teamsB">B1\nB2\nB3\nB4\nB5\nB6</textarea>
          </div>
          <div>
            <label>Gruppe C</label>
            <textarea id="teamsC">C1\nC2\nC3\nC4\nC5\nC6</textarea>
          </div>
        </div>
        <div class="row">
          <label>Regel-Preset</label>
          <select id="preset">
            <option value="custom">Eigenes Mapping</option>
            <option value="cl" selected>Champions-League-Modus</option>
          </select>
          <span class="hint">CL: F1 = W1 vs W2 · F2 = W3 vs L1 · F3 = L3 vs L2</span>
        </div>
        <details class="card" style="background:#0b1226; border-color:#1e293b">
          <summary><strong>Regel-Editor</strong> (optional; überschreibt Preset)</summary>
          <p class="hint">Rollen aus vorheriger Runde: <code>W1,L1,W2,L2,W3,L3</code></p>
          <div class="grid grid-3">
            <div>
              <h3>A</h3>
              <div class="row"><select id="A_F1_H"></select><select id="A_F1_A"></select></div>
              <div class="row"><select id="A_F2_H"></select><select id="A_F2_A"></select></div>
              <div class="row"><select id="A_F3_H"></select><select id="A_F3_A"></select></div>
            </div>
            <div>
              <h3>B</h3>
              <div class="row"><select id="B_F1_H"></select><select id="B_F1_A"></select></div>
              <div class="row"><select id="B_F2_H"></select><select id="B_F2_A"></select></div>
              <div class="row"><select id="B_F3_H"></select><select id="B_F3_A"></select></div>
            </div>
            <div>
              <h3>C</h3>
              <div class="row"><select id="C_F1_H"></select><select id="C_F1_A"></select></div>
              <div class="row"><select id="C_F2_H"></select><select id="C_F2_A"></select></div>
              <div class="row"><select id="C_F3_H"></select><select id="C_F3_A"></select></div>
            </div>
          </div>
        </details>
        <div class="row">
          <button class="btn primary" id="btnGenerate">Slots & Runde 1 anlegen</button>
          <button class="btn" id="btnSave">Speichern (local)</button>
          <button class="btn" id="btnLoad">Laden (local)</button>
          <button class="btn warn" id="btnReset">Alles zurücksetzen</button>
        </div>
        <div class="row">
          <button class="btn accent" id="btnShare">Zuschauer-Link generieren</button>
          <button class="btn" id="btnExportJSON">Export schedule.json</button>
        </div>
        <div class="hint" id="shareOut"></div>
      </div>
    </section>

    <section class="card">
      <h2>Nur nächste Runde pro Gruppe</h2>
      <div class="hint">Speichere pro Gruppe 3 Ergebnisse oder klicke die Sieger-Buttons – erst dann wird die nächste Runde erzeugt und angezeigt.</div>
      <div class="tableWrap">
        <table id="scheduleTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Start</th>
              <th>Ende</th>
              <th>Gruppe</th>
              <th>Runde</th>
              <th>Feld</th>
              <th>Team 1</th>
              <th>Team 2</th>
              <th>Ergebnis</th>
            </tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="btnRegenerate">Zeitslots neu berechnen</button>
      </div>
    </section>
  </div>

  <div class="footer">TSV Königsbrunn – Hallenmasters · Admin · © 2025</div>

  <script>
    // Sticky header offset
    function updateStickyTopFromHeader(){
      const h=document.querySelector('header'); if(!h) return;
      document.documentElement.style.setProperty('--page-header-height', Math.ceil(h.getBoundingClientRect().height)+'px');
    }
    window.addEventListener('load', updateStickyTopFromHeader);
    window.addEventListener('resize', updateStickyTopFromHeader);
    if('ResizeObserver' in window){ new ResizeObserver(updateStickyTopFromHeader).observe(document.querySelector('header')); }

    const ROLES=['W1','L1','W2','L2','W3','L3'];
    const $=sel=>document.querySelector(sel);
    function parseTeams(text){ return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
    function pad2(n){return String(n).padStart(2,'0')}
    function addMinutes(timeHHMM, minutes){ const [h,m]=timeHHMM.split(':').map(Number); const d=new Date(2000,0,1,h,m); d.setMinutes(d.getMinutes()+minutes); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

    // State
    let slots=[]; let slotAssignments=[]; let rotationActive=[];
    let currentRound={A:1,B:1,C:1}; let matches=[]; let results={};

    function buildSelectOptions(sel){ sel.innerHTML=''; for(const r of ROLES){ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o);} }
    function applyPresetCL(){ const set=(g,f,h,a)=>{ $(`#${g}_F${f}_H`).value=h; $(`#${g}_F${f}_A`).value=a; };
      for(const g of ['A','B','C']){ set(g,1,'W1','W2'); set(g,2,'W3','L1'); set(g,3,'L3','L2'); } }
    (function initRuleEditor(){ for(const g of ['A','B','C']){ for(const f of [1,2,3]){ buildSelectOptions($(`#${g}_F${f}_H`)); buildSelectOptions($(`#${g}_F${f}_A`)); } } applyPresetCL(); })();
    $('#preset').addEventListener('change', ()=>{ if($('#preset').value==='cl') applyPresetCL(); });

    function collectConfig(){
      const groups={ A:parseTeams($('#teamsA').value), B:parseTeams($('#teamsB').value), C:parseTeams($('#teamsC').value) };
      for(const g of Object.keys(groups)){ if(groups[g].length===0) delete groups[g]; }
      return {
        title: $('#title').value||'Turnier',
        startTime: $('#startTime').value||'10:00',
        gameMinutes: parseInt($('#gameMinutes').value,10),
        breakMinutes: parseInt($('#breakMinutes').value,10),
        rotationPattern: $('#rotationPattern').value,
        groups,
        mapping: {A:getMapping('A'),B:getMapping('B'),C:getMapping('C')}
      };
    }
    function getMapping(group){ const m={}; for(const f of [1,2,3]){ m[`Feld ${f}`]=[$(`#${group}_F${f}_H`).value,$(`#${group}_F${f}_A`).value]; } return m; }

    function seedPairs(teams){ return [[teams[0],teams[1]],[teams[2],teams[3]],[teams[4],teams[5]]].filter(p=>p[0]&&p[1]); }
    function buildSlotAssignments(startTime, minutesPerSlot, rotationPattern, presentGroups, maxSlots=120){
      const rotRaw=rotationPattern.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
      let rot=rotRaw.filter(g=>presentGroups.includes(g)); if(rot.length===0) rot=[...presentGroups]; rotationActive=rot;
      const assigns=[]; const s=[]; let t=startTime;
      for(let i=0;i<maxSlots;i++){ const g=rot[i%rot.length]; const end=addMinutes(t, minutesPerSlot); assigns.push({group:g}); s.push({start:t,end,group:g}); t=end; }
      return {assigns, slots:s};
    }
    function countOccurrences(group){ let c=0; for(const a of slotAssignments){ if(a.group===group) c++; } return c; }
    function ensureSlotFor(group, n){ if(countOccurrences(group)>=n) return; const cfg=collectConfig(); const minutesPerSlot=cfg.gameMinutes+cfg.breakMinutes; let t=slots.length?slots[slots.length-1].end:cfg.startTime; let guard=0; while(countOccurrences(group)<n && guard++<500){ for(const g of rotationActive){ const end=addMinutes(t, minutesPerSlot); slotAssignments.push({group:g}); slots.push({start:t,end,group:g}); t=end; } } }
    function nthGroupSlotIndex(group, n){ ensureSlotFor(group,n); let c=0; for(let i=0;i<slotAssignments.length;i++){ if(slotAssignments[i].group===group){ c++; if(c===n) return i; } } return -1; }

    function addRoundMatches(group, round, pairs){ const idx=nthGroupSlotIndex(group, round); if(idx<0){ alert(`Zu wenige Slots für Gruppe ${group} Runde ${round}`); return; } const cfg=collectConfig(); const slot=slots[idx]; const end=addMinutes(slot.start, cfg.gameMinutes); for(let f=1; f<=3; f++){ const p=pairs[f-1]||['TBD','TBD']; matches.push({ slot: idx+1, start: slot.start, end, group, round, field:`Feld ${f}`, team1:p[0], team2:p[1] }); } }

    function generateInitial(){ matches=[]; results={}; currentRound={A:1,B:1,C:1}; const cfg=collectConfig(); const present=Object.keys(cfg.groups); const built=buildSlotAssignments(cfg.startTime, cfg.gameMinutes+cfg.breakMinutes, cfg.rotationPattern, present, 120); slotAssignments=built.assigns; slots=built.slots; for(const g of present){ addRoundMatches(g,1,seedPairs(cfg.groups[g])); } renderSchedule(); }

    function getSavedResult(group, round, field){ return results[group]?.[round]?.[field]; }
    function allThreeResultsPresent(group, round){ const r=results[group]?.[round]; if(!r) return false; for(let f=1; f<=3; f++){ const rr=r[`Feld ${f}`]; if(!rr || !Number.isFinite(rr.g1) || !Number.isFinite(rr.g2) || rr.g1===rr.g2) return false; } return true; }
    function computeOutcomesFor(group, round){ const r=results[group]?.[round]; if(!r) return null; const out={}; for(let f=1; f<=3; f++){ const res=r[`Feld ${f}`]; const match=matches.find(m=>m.group===group && m.round===round && m.field===`Feld ${f}`); if(!match||!res) return null; const {g1,g2}=res; if(!Number.isFinite(g1)||!Number.isFinite(g2)) return null; if(g1===g2) return {draw:true}; const W=g1>g2?match.team1:match.team2; const L=g1>g2?match.team2:match.team1; out[`W${f}`]=W; out[`L${f}`]=L; } return out; }
    function nextPairs(outcomes, mapping){ const pairs=[]; for(let f=1; f<=3; f++){ const refs=mapping[`Feld ${f}`]||[]; const a=outcomes?.[refs[0]]||'TBD'; const b=outcomes?.[refs[1]]||'TBD'; pairs.push([a,b]); } return pairs; }

    function onResultSaved(group, round){ if(!allThreeResultsPresent(group, round)) { renderSchedule(); return; } const cfg=collectConfig(); const outcomes=computeOutcomesFor(group, round); if(!outcomes||outcomes.draw){ renderSchedule(); return; } const pairs=nextPairs(outcomes, cfg.mapping[group]); const nextRound=round+1; addRoundMatches(group, nextRound, pairs); currentRound[group]=nextRound; renderSchedule(); }
    function saveResult(group, round, field, g1, g2){ if(!results[group]) results[group]={}; if(!results[group][round]) results[group][round]={}; results[group][round][field]={g1,g2}; onResultSaved(group, round); }

    function renderSchedule(){ const tbody=$('#scheduleBody'); tbody.innerHTML=''; const filtered=matches.filter(m=>m.round===currentRound[m.group]); for(const m of filtered){ const tr=document.createElement('tr'); const t1=m.team1||'TBD', t2=m.team2||'TBD'; const saved=getSavedResult(m.group, m.round, m.field); const g1v=(saved && Number.isFinite(saved.g1))?saved.g1:''; const g2v=(saved && Number.isFinite(saved.g2))?saved.g2:''; tr.innerHTML=`<td>${m.slot}</td><td>${m.start}</td><td>${m.end}</td><td><span class="groupTag ${m.group}">${m.group}</span></td><td>${m.round}</td><td>${m.field}</td><td>${t1}</td><td>${t2}</td><td><div class="row" style="gap:6px; align-items:center"><input type="number" min="0" placeholder="0" value="${g1v}" style="width:64px; text-align:center" /><span style="opacity:.7">:</span><input type="number" min="0" placeholder="0" value="${g2v}" style="width:64px; text-align:center" /><button class="btn inline" data-action="save">Speichern</button><span class="hint">oder</span><button class="btn inline" data-action="t1win">${t1} siegt</button><button class="btn inline" data-action="t2win">${t2} siegt</button>${saved?'<span class="saved">✓ gespeichert</span>':''}</div></td>`; const inputs=tr.querySelectorAll('input'); const btnSave=tr.querySelector('button[data-action="save"]'); const btnT1=tr.querySelector('button[data-action="t1win"]'); const btnT2=tr.querySelector('button[data-action="t2win"]'); const commit=(a,b)=>{ if(!Number.isFinite(a)||!Number.isFinite(b)){ alert('Bitte gültige Tore eingeben.'); return; } saveResult(m.group, m.round, m.field, a, b); };
      btnSave.addEventListener('click', ()=>{ const g1=parseInt(inputs[0].value,10); const g2=parseInt(inputs[1].value,10); commit(g1,g2); }); btnT1.addEventListener('click', ()=>commit(1,0)); btnT2.addEventListener('click', ()=>commit(0,1)); tbody.appendChild(tr); }
    }

    // Publish helpers
    function encodeBase64Utf8(str){ const utf8=new TextEncoder().encode(str); let bin=''; utf8.forEach(b=>bin+=String.fromCharCode(b)); return btoa(bin); }
    function exportJSON(){ const payload=buildPublishPayload(); const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='schedule.json'; a.click(); URL.revokeObjectURL(url); }
    function buildPublishPayload(){ const cfg=collectConfig(); const now=new Date().toISOString(); const pubMatches=matches.filter(m=>m.round===currentRound[m.group]); return { title: cfg.title, generatedAt: now, currentRound, slots, matches: pubMatches } }
    function shareLink(){ const payload=buildPublishPayload(); const b64=encodeBase64Utf8(JSON.stringify(payload)); const url=new URL(window.location.href); url.pathname=url.pathname.replace('admin.html','viewer.html'); url.search='?s='+b64; $('#shareOut').innerHTML=`<strong>Link für Zuschauer:</strong><br><a href="${url.toString()}" target="_blank">${url.toString()}</a>`; }

    // Persistence
    function saveConfigLocal(){ const cfg=collectConfig(); localStorage.setItem('funino_combo_cfg', JSON.stringify(cfg)); localStorage.setItem('funino_combo_state', JSON.stringify({results,matches,currentRound,slots,slotAssignments,rotationActive})); }
    function loadConfigLocal(){ const raw=localStorage.getItem('funino_combo_cfg'); const rawS=localStorage.getItem('funino_combo_state'); if(raw){ try{ const cfg=JSON.parse(raw); $('#title').value=cfg.title||''; $('#startTime').value=cfg.startTime||'10:00'; $('#gameMinutes').value=cfg.gameMinutes||10; $('#breakMinutes').value=cfg.breakMinutes||2; $('#rotationPattern').value=cfg.rotationPattern||'A,B,C'; if(cfg.groups?.A) $('#teamsA').value=cfg.groups.A.join('\n'); if(cfg.groups?.B) $('#teamsB').value=cfg.groups.B.join('\n'); if(cfg.groups?.C) $('#teamsC').value=cfg.groups.C.join('\n'); if(cfg.mapping){ for(const g of ['A','B','C']){ for(const f of [1,2,3]){ const map=cfg.mapping[g]?.[`Feld ${f}`]; if(map){ $(`#${g}_F${f}_H`).value=map[0]; $(`#${g}_F${f}_A`).value=map[1]; } } } } }catch(e){} }
      if(rawS){ try{ const s=JSON.parse(rawS); results=s.results||{}; matches=s.matches||[]; currentRound=s.currentRound||{A:1,B:1,C:1}; slots=s.slots||[]; slotAssignments=s.slotAssignments||[]; rotationActive=s.rotationActive||[]; }catch(e){} }
    }

    // Wiring
    $('#btnGenerate').addEventListener('click', ()=>{ generateInitial(); });
    $('#btnRegenerate').addEventListener('click', ()=>{ const cfg=collectConfig(); const present=Object.keys(cfg.groups); const built=buildSlotAssignments(cfg.startTime, cfg.gameMinutes+cfg.breakMinutes, cfg.rotationPattern, present, 120); slotAssignments=built.assigns; slots=built.slots; renderSchedule(); });
    $('#btnSave').addEventListener('click', ()=>{ saveConfigLocal(); });
    $('#btnLoad').addEventListener('click', ()=>{ loadConfigLocal(); renderSchedule(); alert('Geladen (falls vorhanden).'); });
    $('#btnReset').addEventListener('click', ()=>{ if(confirm('Alles zurücksetzen?')){ localStorage.removeItem('funino_combo_cfg'); localStorage.removeItem('funino_combo_state'); location.reload(); } });
    $('#btnShare').addEventListener('click', ()=>{ shareLink(); });
    $('#btnExportJSON').addEventListener('click', ()=>{ exportJSON(); });

    // Init
    loadConfigLocal(); if(matches.length===0){ try{ generateInitial(); }catch(e){ console.warn(e); } } renderSchedule();
  </script>
</body>
</html>