
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viewer â€“ 3. KÃ¶nigsbrunner Miniâ€‘FuÃŸball Hallenmasters</title>

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --border:#1f2937;

      /* Sticky-Offsets (werden per JS gesetzt) */
      --sticky-offset: 64px;  /* HÃ¶he Haupt-Header */
      --sticky-sec: 42px;     /* HÃ¶he Abschnitt-Header */

      /* Zeitspaltenbreite + Gap (Tiles) */
      --time-col-w: 102px;    /* 90px .slotTime + 12px Gap */

      /* HÃ¶he des Feld-Kopfes Ã¼ber den Tiles (per JS gesetzt) */
      --tiles-head-h: 0px;
    }

    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Arial;
    }

    /* ===== STICKY: Hauptheader (Logo/Status) ===== */
    body > header{
      position: sticky; top: 0; z-index: 1000;
      background: var(--card);
      border-bottom:1px solid var(--border);
      box-shadow: 0 2px 0 rgba(0,0,0,.15);
    }
    .bar{display:flex; align-items:center; justify-content:space-between; gap:1rem; padding:.75rem 1rem;}
    .leftWrap{display:flex; align-items:center; gap:.75rem;}
    .clubLogo{width:48px; height:48px; object-fit:contain; border-radius:6px; background:#0b1020; border:1px solid var(--border);}
    h1{margin:0; font-size:1.15rem;}
    .meta{display:flex; gap:.75rem; align-items:center; color:var(--muted); font-size:.9rem;}
    .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border); font-size:.85rem;}
    .pill.ok{color:#d1fae5; border-color:#065f46; background:#064e3b;}
    .pill.err{color:#fee2e2; border-color:#7f1d1d; background:#1b0f0a;}

    main{max-width:1200px; margin:0 auto; padding:1rem;}

    /* ===== STICKY: Abschnitt-Header (â€žSpielÃ¼bersichtâ€œ + Umschalter) ===== */
    section{background:var(--card); border:1px solid var(--border); border-radius:8px; margin-bottom:1rem;}
    section > header{
      display:flex; align-items:center; justify-content:space-between;
      padding:.75rem 1rem; border-bottom:1px solid var(--border);
      position: sticky; top: var(--sticky-offset); z-index: 900;
      background: var(--card);
      box-shadow: 0 2px 0 rgba(0,0,0,.15);
    }
    .viewToggle{display:flex; gap:.35rem; flex-wrap:wrap;}
    .btn{
      cursor:pointer; border:1px solid var(--border); background:#0b1020; color:#e5e7eb;
      padding:.35rem .6rem; border-radius:6px; font-weight:600; font-size:.85rem;
    }
    .btn-active{background:#0b1b3a; border-color:#1d4ed8; color:#bfdbfe;}

    /* ===== Tabellenansicht ===== */
    .tableWrap{padding:1rem; overflow:auto;}
    table{
      width:100%;
      border-collapse: separate; /* kein collapse bei sticky */
      table-layout: fixed;       /* identische Spaltenbreiten */
    }
    th,td{
      padding:.5rem; border-bottom:1px solid var(--border); text-align:left;
      box-sizing:border-box; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tableWrap thead{
      position: sticky; top: 0; z-index: 800; background:#0b1020;
    }
    .tableWrap tbody::before{
      content:''; display:block; height: var(--thead-spacer, 0px);
    }

    /* ZeilenfÃ¤rbung je Gruppe Aâ€“F */
    tr.grpA td{ background:rgba(29,78,216,.08); }
    tr.grpB td{ background:rgba(220,38,38,.08); }
    tr.grpC td{ background:rgba(22,163,74,.08); }
    tr.grpD td{ background:rgba(245,158,11,.12); }
    tr.grpE td{ background:rgba(139,92,246,.12); }
    tr.grpF td{ background:rgba(20,184,166,.12); }

    .grpBadge{display:inline-block; padding:.1rem .4rem; border-radius:999px; font-size:.75rem; border:1px solid var(--border);}
    .grpBadge.A{color:#bfdbfe; background:#0b1b3a; border-color:#1d4ed8;}
    .grpBadge.B{color:#fecaca; background:#2b0c0c; border-color:#7f1d1d;}
    .grpBadge.C{color:#86efac; background:#052e1b; border-color:#166534;}
    .grpBadge.D{color:#fde68a; background:#1f2937; border-color:#f59e0b;}
    .grpBadge.E{color:#ddd6fe; background:#1f2937; border-color:#8b5cf6;}
    .grpBadge.F{color:#a7f3d0; background:#0f3b3a; border-color:#14b8a6;}

    .winIcon{font-size:1rem; margin-right:.3rem; vertical-align:middle;}
    .winnerText{color:var(--ok); font-weight:600;}
    .loserText{color:var(--muted);}
    .note{color:#9ca3af; font-size:.85rem; padding:0 1rem 1rem;}

    /* ===== Kachelansicht (Zeit-Slots Ã— Felder) ===== */
    .tilesWrap{padding:1rem;}
    .slotRow{display:flex; align-items:flex-start; gap:12px; margin-bottom:14px;}
    .slotTime{min-width:90px; flex:0 0 90px; text-align:right; padding-top:.35rem;}
    .slotTime .timeBadge{display:inline-block; border:1px solid var(--border); border-radius:8px; padding:.2rem .5rem; font-weight:700; color:#cbd5e1; background:#0b1020;}

    .tilesHeadGlobal{display:grid; gap:12px; margin:8px 0 10px;}
    .fieldHead{display:flex; justify-content:center;}
    .fieldHeadBadge{display:inline-block; border:1px solid var(--border); border-radius:10px; padding:.25rem .6rem; font-weight:700; font-size:.95rem; color:#cbd5e1; background:#0b1020;}
    .tilesGrid{display:grid; gap:12px; flex:1;}
    @media (max-width: 680px){
      .slotTime{display:none;}
      .tilesHeadGlobal{display:none;}
      :root{ --time-col-w: 0px; }
    }

    .tile{
      background-color: #111827;
      border:1px solid var(--border);
      border-radius:10px;
      padding:.6rem .8rem;
      display:flex; flex-direction:column; gap:.4rem;
    }
    .tile.grpA{ background-color: #0b1b3a; border-color: #1d4ed8; }
    .tile.grpB{ background-color: #2b0c0c; border-color: #7f1d1d; }
    .tile.grpC{ background-color: #052e1b; border-color: #166534; }
    .tile.grpD{ background-color: #1f2937; border-color: #f59e0b; }
    .tile.grpE{ background-color: #1f2937; border-color: #8b5cf6; }
    .tile.grpF{ background-color: #0f3b3a; border-color: #14b8a6; }

    .tileTop{display:flex; justify-content:space-between; align-items:center;}
    .tileTopLeft{display:flex; gap:.4rem; align-items:center; flex-wrap:wrap;}
    .tileTag{display:inline-flex; align-items:center; gap:.35rem; border:1px solid var(--border); border-radius:999px; padding:.1rem .5rem; font-size:.85rem; color:#cbd5e1;}
    .tileMain{display:flex; justify-content:space-between; gap:.75rem; align-items:center;}
    .teamText{display:inline-flex; align-items:center; gap:.35rem;}
    .emptyMsg{color:#9ca3af; padding:1rem;}
    .idTag{display:inline-block; border:1px solid var(--border); border-radius:8px; padding:.1rem .45rem; font-size:.8rem; color:#cbd5e1; background:#0b1020; margin-left:.4rem;}
    .roundBadge{display:inline-block; margin-top:.35rem; border:1px solid var(--border); border-radius:8px; padding:.12rem .5rem; font-weight:700; font-size:.9rem; color:#e5e7eb; background:#0b1020;}

    /* ===== 3. View: Hallenlayout (nur Bild) ===== */
    .hallWrap{
      padding: 1rem;
      display: flex; align-items: center; justify-content: center;
      min-height: 40vh;
    }
    .hallWrap .hall-img{
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 18px rgba(0,0,0,.25);
      background: #0b1020;
    }

    /* ===== NEW: Teams-View ===== */
    .teamsWrap{ padding:1rem; }
    .teamsGrid{ display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap: 16px; }
    @media (max-width: 980px){ .teamsGrid{ grid-template-columns: repeat(2, minmax(260px, 1fr)); } }
    @media (max-width: 680px){ .teamsGrid{ grid-template-columns: 1fr; } }
    .teamCard{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px; }
	.teamCard.grpA{ border-color:#1d4ed8; }
    .teamCard.grpB{ border-color:#7f1d1d; }
    .teamCard.grpC{ border-color:#166534; }
    .teamCard.grpD{ border-color:#f59e0b; }
    .teamCard.grpE{ border-color:#8b5cf6; }
    .teamCard.grpF{ border-color:#14b8a6; }
	
    .teamCardHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
    .teamBadge{ display:inline-block; border:1px solid var(--border); border-radius:10px; padding:.2rem .5rem; font-weight:700; font-size:.9rem; color:#cbd5e1; background:#0b1020; }
	.teamBadge.A{ color:#bfdbfe; background:#0b1b3a; border-color:#1d4ed8; }
    .teamBadge.B{ color:#fecaca; background:#2b0c0c; border-color:#7f1d1d; }
    .teamBadge.C{ color:#86efac; background:#052e1b; border-color:#166534; }
    .teamBadge.D{ color:#fde68a; background:#1f2937; border-color:#f59e0b; }
    .teamBadge.E{ color:#ddd6fe; background:#1f2937; border-color:#8b5cf6; }
    .teamBadge.F{ color:#a7f3d0; background:#0f3b3a; border-color:#14b8a6; }
	
    .teamList{ list-style:none; margin:0; padding:0; }
    .teamItem{ padding:.35rem .5rem; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:.5rem; }
    .teamEmpty{ color:#9ca3af; font-style:italic; }
    .teamCount{ color:#9ca3af; font-size:.85rem; }
	
	/* kleiner Farbpunk vor Namen */
    .teamDot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .teamDot.A{ background:#1d4ed8; }  /* Blau */
    .teamDot.B{ background:#7f1d1d; }  /* Rotbraun */
    .teamDot.C{ background:#166534; }  /* GrÃ¼n */
    .teamDot.D{ background:#f59e0b; }  /* Orange */
    .teamDot.E{ background:#8b5cf6; }  /* Violett */
    .teamDot.F{ background:#14b8a6; }  /* Teal */

    /* ===== View-Umschaltung ===== */
    #tableView, #tilesView, #hallView, #teamsView{ display:none; }
    .view-table #tableView{ display:block; }
    .view-tiles #tilesView{ display:block; }
    .view-hall  #hallView { display:block; }
    .view-teams #teamsView{ display:block; }
  </style>
</head>
<body class="view-tiles">
  <!-- ===== STICKY: Hauptheader ===== -->
  <header>
    <div class="bar">
      <div class="leftWrap">
        <img id="clubLogo" class="clubLogo" alt="Vereinslogo" />
        <div>
          <h1>3. KÃ¶nigsbrunner Miniâ€‘FuÃŸball Hallenmasters</h1>
          <div class="meta">
            <span>21./22.02.2026</span>
            <span id="lastUpdate" class="pill err" title="Zuletzt geladene Daten">Letztes Update: â€“</span>
          </div>
        </div>
      </div>
      <div class="meta">
        <span id="connStatus" class="pill err">Status: getrennt</span>
      </div>
    </div>
  </header>

  <main>
    <section>
      <header id="sectionHeader">
        <div style="display:flex; align-items:center; gap:.75rem;">
          <h2 style="margin:0;">SpielÃ¼bersicht</h2>
          <span class="note">Liveâ€‘Aktualisierung bei Ergebnissen, Gruppenstart, Rundenfortschritt und Reset.</span>
        </div>
        <div class="viewToggle">
          <button id="btnViewTable" class="btn"             type="button">Tabellenansicht</button>
          <button id="btnViewTiles" class="btn btn-active"  type="button">Kachelansicht</button>
          <button id="btnViewHall"  class="btn"             type="button">Hallenlayout</button>
          <button id="btnViewTeams" class="btn"             type="button">Teams</button>
        </div>
      </header>

      <!-- 1) Tabellenansicht -->
      <div id="tableView" class="tableWrap">
        <table id="matchesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Gruppe</th>
              <th>Runde</th>
              <th>Feld</th>
              <th>Zeit</th>
              <th>Team A</th>
              <th>Team B</th>
              <th>Sieger</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- 2) Kachelansicht -->
      <div id="tilesView" class="tilesWrap">
        <!-- globaler Kopf mit Feld-Labels nur einmal -->
        <div id="tilesHeadGlobal" class="tilesHeadGlobal"></div>
        <div id="tilesContainer"></div>
        <div id="tilesEmpty" class="emptyMsg" style="display:none">Noch keine Spiele geplant.</div>
      </div>

      <!-- 3) Hallenlayout (nur Bild) -->
      <div id="hallView" class="hallWrap">
        <img id="hallImage" class="hall-img" alt="Hallenlayout" />
      </div>

      <!-- NEW: Teams-Ansicht -->
      <div id="teamsView" class="teamsWrap">
        <div id="teamsGrid" class="teamsGrid"></div>
        <div id="teamsEmpty" class="emptyMsg" style="display:none">Es wurden noch keine Teams eingetragen.</div>
      </div>
    </section>
  </main>

  <!-- Socket.IO Client korrekt laden -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- ===== Viewer Logik (Teile 2â€“4 zusammengefÃ¼hrt) ===== -->
  <script>
    // === Konfiguration: Pfad zum Hallenlayout-Bild
    var HALL_IMG_PATH = '/assets/bg_hallenmasters_Gym.jpg';

    // === Logo laden (optional)
    (function setLogo(){
      var LOGO_PATH = '/assets/Fussballwappen_logo.png';
      var img = document.getElementById('clubLogo');
      if (!img) return;
      var url = LOGO_PATH + '?_v=' + Date.now();
      img.onload  = function(){};
      img.onerror = function(){ img.style.display='none'; };
      img.src = url;
    })();

    // === Hallenlayout-Bild setzen (mit robuster Fehlerbehandlung)
    (function setHallImage(){
      var img = document.getElementById('hallImage');
      if (!img) return;
      var url = HALL_IMG_PATH + '?_v=' + Date.now();
      img.onload  = function(){ img.style.display='block'; };
      img.onerror = function(){ console.warn('Hallenlayout konnte nicht geladen werden:', url); img.style.display='none'; };
      img.src = url;
    })();

    // === Kleine Helfer
    function groupClass(g){
      var x = String(g || '').trim().toUpperCase();
      switch (x) {
        case 'A': return 'grpA';
        case 'B': return 'grpB';
        case 'C': return 'grpC';
        case 'D': return 'grpD';
        case 'E': return 'grpE';
        case 'F': return 'grpF';
        default:  return null;
      }
    }
    function addClassSafe(el, cls){ if (el && cls) el.classList.add(cls); }
    function setStatus(ok){
      var el = document.getElementById('connStatus');
      if (!el) return;
      if (ok){ el.textContent = 'Status: verbunden'; el.className = 'pill ok'; }
      else   { el.textContent = 'Status: getrennt';  el.className = 'pill err'; }
    }
    function setLastUpdate(){
      var el = document.getElementById('lastUpdate');
      if (!el) return;
      var now = new Date();
      var hh = String(now.getHours()).padStart(2,'0');
      var mm = String(now.getMinutes()).padStart(2,'0');
      var ss = String(now.getSeconds()).padStart(2,'0');
      el.textContent = 'Letztes Update: ' + hh + ':' + mm + ':' + ss;
      el.className = 'pill ok';
    }

    // === Daten laden
    var API_BASE = window.location.origin + '/api';
    function safeFetch(path, init){
      return fetch(API_BASE + path, init).then(function(res){
        if (!res.ok){
          return res.text().then(function(txt){ throw new Error('HTTP '+res.status+' '+res.statusText+(txt?': '+txt:'')); });
        }
        return res.json();
      });
    }
    function loadMatches(){ return safeFetch('/matches', { method:'GET' }); }
    function loadTeams(){ return safeFetch('/teams', { method:'GET' }); }

    // === Tabellen-Rendering
    function renderTable(rows){
      var tbody = document.querySelector('#matchesTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!Array.isArray(rows) || !rows.length){
        var tr0 = document.createElement('tr');
        var td0 = document.createElement('td');
        td0.colSpan = 8;
        td0.textContent = 'Noch keine Spiele geplant.';
        td0.style.color = '#9ca3af';
        tr0.appendChild(td0);
        tbody.appendChild(tr0);
        updateTheadSpacer();
        return;
      }

      for (var i=0; i<rows.length; i++){
        var m = rows[i];
        var tr = document.createElement('tr');
        addClassSafe(tr, groupClass(m && m.groupName));

        var id        = (m && m.id != null) ? m.id : '';
        var groupName = (m && m.groupName) ? m.groupName : '';
        var round     = (m && m.round != null) ? m.round : '';
        var field     = (m && m.field != null) ? m.field : '';
        var teamAId   = (m && (m.teamA_id!=null || m.teamA!=null)) ? (m.teamA_id!=null?m.teamA_id:m.teamA) : null;
        var teamBId   = (m && (m.teamB_id!=null || m.teamB!=null)) ? (m.teamB_id!=null?m.teamB_id:m.teamB) : null;
        var teamAName = (m && m.teamA && typeof m.teamA==='string') ? m.teamA : (teamAId!=null?String(teamAId):'');
        var teamBName = (m && m.teamB && typeof m.teamB==='string') ? m.teamB : (teamBId!=null?String(teamBId):'');
        var planned   = (m && m.plannedStart) ? m.plannedStart : 'â€“';

        var winnerVal = (m && typeof m.winner!=='undefined') ? m.winner : null;
        var hasWinner = (winnerVal!==null && winnerVal!==undefined);

        var tdId    = document.createElement('td'); tdId.textContent = id;

        var tdGroup = document.createElement('td');
        var badge   = document.createElement('span');
        var gTrim   = String(groupName || '').trim().toUpperCase();
        badge.className = 'grpBadge ' + (gTrim || 'A');
        badge.textContent = gTrim || 'A';
        tdGroup.appendChild(badge);

        var tdRound = document.createElement('td'); tdRound.textContent = round;
        var tdField = document.createElement('td'); tdField.textContent = field;
        var tdTime  = document.createElement('td'); tdTime.textContent = planned;

        var tdA = document.createElement('td');
        var wA  = document.createElement('span'); wA.className = 'loserText'; wA.textContent = teamAName;
        if (hasWinner && Number(winnerVal)===Number(teamAId)){
          var icoA = document.createElement('span'); icoA.className='winIcon'; icoA.textContent='ðŸ†'; icoA.setAttribute('aria-label','Sieger');
          wA.className = 'winnerText';
          tdA.appendChild(icoA); tdA.appendChild(wA);
        } else { tdA.appendChild(wA); }

        var tdB = document.createElement('td');
        var wB  = document.createElement('span'); wB.className = 'loserText'; wB.textContent = teamBName;
        if (hasWinner && Number(winnerVal)===Number(teamBId)){
          var icoB = document.createElement('span'); icoB.className='winIcon'; icoB.textContent='ðŸ†'; icoB.setAttribute('aria-label','Sieger');
          wB.className = 'winnerText';
          tdB.appendChild(icoB); tdB.appendChild(wB);
        } else { tdB.appendChild(wB); }

        var tdWinner = document.createElement('td');
        tdWinner.textContent = hasWinner ? ((Number(winnerVal)===Number(teamAId)) ? teamAName : teamBName) : 'â€“';

        tr.appendChild(tdId);
        tr.appendChild(tdGroup);
        tr.appendChild(tdRound);
        tr.appendChild(tdField);
        tr.appendChild(tdTime);
        tr.appendChild(tdA);
        tr.appendChild(tdB);
        tr.appendChild(tdWinner);

        tbody.appendChild(tr);
      }

      updateTheadSpacer();
    }

    // === Tiles-Helpers
    function uniqueSortedFields(rows){
      var set = {};
      for (var i=0; i<rows.length; i++){
        var f = (rows[i] && rows[i].field!=null) ? rows[i].field : null;
        if (f!=null) set[String(f)] = true;
      }
      var arr = Object.keys(set);
      arr.sort(function(a,b){ return Number(a)-Number(b); });
      var out = [];
      for (var j=0;j<arr.length;j++) out.push(Number(arr[j]));
      return out;
    }
    function uniqueSortedTimes(rows){
      var set = {};
      for (var i=0; i<rows.length; i++){
        var t = (rows[i] && rows[i].plannedStart) ? rows[i].plannedStart : null;
        if (t) set[String(t)] = true;
      }
      var arr = Object.keys(set);
      arr.sort(function(a,b){
        if (a==='â€“' && b==='â€“') return 0;
        if (a==='â€“') return 1;
        if (b==='â€“') return -1;
        return String(a).localeCompare(String(b));
      });
      return arr;
    }
    function tileNodeForMatch(m){
      var grp = String((m && m.groupName)||'').trim().toUpperCase();
      var teamAId = (m && m.teamA_id!=null) ? Number(m.teamA_id) : (m && m.teamA!=null ? Number(m.teamA) : NaN);
      var teamBId = (m && m.teamB_id!=null) ? Number(m.teamB_id) : (m && m.teamB!=null ? Number(m.teamB) : NaN);
      var winnerVal = (m && typeof m.winner!=='undefined') ? Number(m.winner) : NaN;

      var tile = document.createElement('div');
      addClassSafe(tile, 'tile');
      addClassSafe(tile, groupClass(grp));

      var top = document.createElement('div'); top.className = 'tileTop';
      var topLeft = document.createElement('div'); topLeft.className = 'tileTopLeft';
      var tag = document.createElement('span'); tag.className = 'tileTag'; tag.textContent = 'Gruppe ' + (grp || 'â€“');
      var idTag = document.createElement('span'); idTag.className = 'idTag'; idTag.textContent = 'ID ' + ((m && m.id!=null)?m.id:'â€“');
      topLeft.appendChild(tag); topLeft.appendChild(idTag);

      var topRight = document.createElement('div');
      var roundSpan = document.createElement('span'); roundSpan.className = 'roundBadge'; roundSpan.textContent = 'Runde ' + ((m && m.round!=null)?m.round:'-');
      topRight.appendChild(roundSpan);

      top.appendChild(topLeft); top.appendChild(topRight);
      tile.appendChild(top);

      var main = document.createElement('div'); main.className = 'tileMain';

      var aWrap = document.createElement('span'); aWrap.className = 'teamText';
      var aTxt  = document.createElement('span'); aTxt.textContent = (m && m.teamA && typeof m.teamA==='string') ? m.teamA : (teamAId?String(teamAId):'');
      aTxt.className = (!isNaN(winnerVal) && winnerVal===teamAId) ? 'winnerText' : 'loserText';
      if (!isNaN(winnerVal) && winnerVal===teamAId){
        var aIco = document.createElement('span'); aIco.className='winIcon'; aIco.textContent='ðŸ†'; aIco.setAttribute('aria-label','Sieger');
        aWrap.appendChild(aIco);
      }
      aWrap.appendChild(aTxt);

      var bWrap = document.createElement('span'); bWrap.className = 'teamText';
      var bTxt  = document.createElement('span'); bTxt.textContent = (m && m.teamB && typeof m.teamB==='string') ? m.teamB : (teamBId?String(teamBId):'');
      bTxt.className = (!isNaN(winnerVal) && winnerVal===teamBId) ? 'winnerText' : 'loserText';
      if (!isNaN(winnerVal) && winnerVal===teamBId){
        var bIco = document.createElement('span'); bIco.className='winIcon'; bIco.textContent='ðŸ†'; bIco.setAttribute('aria-label','Sieger');
        bWrap.appendChild(bIco);
      }
      bWrap.appendChild(bTxt);

      main.appendChild(aWrap);
      main.appendChild(bWrap);
      tile.appendChild(main);

      return tile;
    }

    // === Tiles-Rendering (Zeit-Slots Ã— Felder, globaler Feld-Kopf)
    function renderTiles(rows){
      var head = document.getElementById('tilesHeadGlobal');
      var cont = document.getElementById('tilesContainer');
      var empty = document.getElementById('tilesEmpty');
      if (!head || !cont || !empty) return;
      head.innerHTML = '';
      cont.innerHTML = '';

      if (!Array.isArray(rows) || !rows.length){
        empty.style.display = 'block';
        updateTilesHeadHeight();
        return;
      }
      empty.style.display = 'none';

      // Felder bestimmen und globalen Kopf aufbauen
      var fields = uniqueSortedFields(rows);
      if (!fields.length) fields = [1,2,3];
      head.style.gridTemplateColumns = 'repeat(' + fields.length + ', minmax(260px, 1fr))';
      for (var h=0; h<fields.length; h++){
        var fh = document.createElement('div'); fh.className = 'fieldHead';
        var fb = document.createElement('span'); fb.className = 'fieldHeadBadge'; fb.textContent = 'Feld ' + fields[h];
        fh.appendChild(fb); head.appendChild(fh);
      }

      // Zeiten sammeln
      var times = uniqueSortedTimes(rows);
      if (!times.length) times = ['â€“'];

      for (var ti=0; ti<times.length; ti++){
        var timeKey = times[ti];

        var slot = document.createElement('div'); slot.className = 'slotRow';

        // Zeit links
        var timeCol = document.createElement('div'); timeCol.className = 'slotTime';
        var timeBadge = document.createElement('span'); timeBadge.className = 'timeBadge';
        timeBadge.textContent = timeKey;
        timeCol.appendChild(timeBadge);

        // Grid rechts
        var grid = document.createElement('div'); grid.className = 'tilesGrid';
        grid.style.gridTemplateColumns = 'repeat(' + fields.length + ', minmax(260px, 1fr))';

        // FÃ¼r jedes Feld die passende Partie finden
        for (var fIdx=0; fIdx<fields.length; fIdx++){
          var f = fields[fIdx];

          // Eine zum Zeitpunkt passende Partie mit field==f suchen
          var match = null;
          for (var i=0; i<rows.length; i++){
            var m = rows[i];
            var t = (m && m.plannedStart) ? m.plannedStart : 'â€“';
            var fld = (m && m.field!=null) ? Number(m.field) : null;
            if (t===timeKey && fld===Number(f)){ match = m; break; }
          }

          if (match) {
            grid.appendChild(tileNodeForMatch(match));
          } else {
            // dezenter Platzhalter
            var placeholder = document.createElement('div');
            addClassSafe(placeholder, 'tile');
            var tag = document.createElement('span'); tag.className='tileTag'; tag.textContent = 'â€”';
            placeholder.appendChild(tag);
            grid.appendChild(placeholder);
          }
        }

        slot.appendChild(timeCol);
        slot.appendChild(grid);
        cont.appendChild(slot);
      }

      updateTilesHeadHeight();
    }

    /* ==== Teams Rendering ==== */
    function renderTeamsGrid(teams){
      var grid=document.getElementById('teamsGrid'), empty=document.getElementById('teamsEmpty');
      if(!grid||!empty) return;
      grid.innerHTML='';
      if(!Array.isArray(teams)||teams.length===0){
        empty.style.display='block'; return;
      }
      empty.style.display='none';
      // Gruppen Aâ€“F
      var groups = ['A','B','C','D','E','F'];
      groups.forEach(function(g){
        var list = teams.filter(function(t){ return String(t.groupName||'').trim().toUpperCase()===g; })
                        .sort(function(a,b){ return String(a.name||'').localeCompare(String(b.name||'')); });
        var card=document.createElement('div'); card.className='teamCard'; addClassSafe(card, groupClass(g)); /* farbiger Rahmen */
        var head = document.createElement('div'); head.className='teamCardHeader';
        var badge=document.createElement('span'); badge.className='teamBadge '+g; badge.textContent='Gruppe '+g; /* farbige Badge */
        var count = document.createElement('span'); count.className='teamCount'; count.textContent = list.length+' Team(s)';
        head.appendChild(badge); head.appendChild(count); card.appendChild(head);
        var ul = document.createElement('ul'); ul.className='teamList';
        if (list.length===0){
          var li = document.createElement('li'); li.className='teamItem teamEmpty'; li.textContent='â€“ keine Teams â€“';
          ul.appendChild(li);
        } else {
          list.forEach(function(t){
            var li=document.createElement('li'); li.className='teamItem';
            var dot=document.createElement('span'); dot.className='teamDot '+g; /* farbiger Punkt */
            var name=document.createElement('span'); name.textContent=t.name;
            li.appendChild(dot); li.appendChild(name);
            ul.appendChild(li);
          });
        }
        card.appendChild(ul);
        grid.appendChild(card);
      });
    }

    // === Umschalter (4 Views)
    function setView(mode){
      var body = document.body;
      var btnT = document.getElementById('btnViewTable');
      var btnK = document.getElementById('btnViewTiles');
      var btnH = document.getElementById('btnViewHall');
      var btnTe= document.getElementById('btnViewTeams');

      // Body-Klasse setzen
      body.classList.remove('view-table','view-tiles','view-hall','view-teams');
      if (mode==='table') body.classList.add('view-table');
      else if (mode==='hall') body.classList.add('view-hall');
      else if (mode==='teams') body.classList.add('view-teams');
      else body.classList.add('view-tiles');

      [btnT,btnK,btnH,btnTe].forEach(function(b){ b && b.classList.remove('btn-active'); });

      if (mode==='table') btnT.classList.add('btn-active');
      else if (mode==='hall') btnH.classList.add('btn-active');
      else if (mode==='teams') btnTe.classList.add('btn-active');
      else btnK.classList.add('btn-active');

      updateStickyOffsets();
      updateTheadSpacer();
      updateTilesHeadHeight();

      if (mode==='teams'){ // bei Wechsel auf Teams: neu laden/anzeigen
        loadTeams().then(renderTeamsGrid).catch(function(e){ console.warn('Teams laden fehlgeschlagen:', e); });
      }
    }
    document.getElementById('btnViewTable').addEventListener('click', function(){ setView('table'); });
    document.getElementById('btnViewTiles').addEventListener('click', function(){ setView('tiles'); });
    document.getElementById('btnViewHall').addEventListener('click',  function(){ setView('hall'); });
    document.getElementById('btnViewTeams').addEventListener('click', function(){ setView('teams'); });

    // === Sticky-Offsets dynamisch setzen
    function updateStickyOffsets(){
      var topHdr = document.querySelector('body > header');
      var secHdr = document.getElementById('sectionHeader');
      var topH   = topHdr ? Math.ceil(topHdr.getBoundingClientRect().height) : 0;
      var secH   = secHdr ? Math.ceil(secHdr.getBoundingClientRect().height) : 0;
      document.documentElement.style.setProperty('--sticky-offset', topH + 'px');
      document.documentElement.style.setProperty('--sticky-sec', secH + 'px');
    }
    window.addEventListener('load', updateStickyOffsets);
    window.addEventListener('resize', updateStickyOffsets);
    setTimeout(updateStickyOffsets, 350);

    // === Thead-Spacer (HÃ¶he des Kopfes) setzen
    function updateTheadSpacer(){
      var tw = document.querySelector('.tableWrap');
      var thead = tw ? tw.querySelector('thead') : null;
      if (!thead || !tw) return;
      var h = Math.ceil(thead.getBoundingClientRect().height) || 0;
      tw.style.setProperty('--thead-spacer', h + 'px');
    }
    window.addEventListener('load', updateTheadSpacer);
    window.addEventListener('resize', updateTheadSpacer);

    // === Tiles-Head-HÃ¶he setzen (fÃ¼r Reflows in Tiles)
    function updateTilesHeadHeight(){
      var head = document.getElementById('tilesHeadGlobal');
      if (!head) return;
      var h = Math.ceil(head.getBoundingClientRect().height) || 0;
      document.documentElement.style.setProperty('--tiles-head-h', h + 'px');
    }
    window.addEventListener('load', updateTilesHeadHeight);
    window.addEventListener('resize', updateTilesHeadHeight);
	
    // === VollstÃ¤ndige Aktualisierung
    function refresh(){
      return loadMatches()
        .then(function(rows){
          renderTable(rows);
          renderTiles(rows);
          setLastUpdate();
        })
        .catch(function(e){
          console.error('Laden fehlgeschlagen:', e);
          var el = document.getElementById('lastUpdate');
          if (el){ el.textContent = 'Letztes Update: Fehler'; el.className = 'pill err'; }
          setStatus(false);
        });
    }

    // === Socket.IO Initialisierung (ES5)
    (function initSocket(){
      if (typeof io !== 'function'){
        console.error('Socket.IO Client nicht geladen â€“ prÃ¼fe /socket.io/socket.io.js');
        setStatus(false);
        return;
      }
      var base = window.location.origin;
      var s = io(base, {
        path:'/socket.io',
        transports:['websocket','polling'],
        reconnectionAttempts:10,
        timeout:10000
      });

      s.on('connect', function(){ setStatus(true); updateStickyOffsets(); updateTheadSpacer(); updateTilesHeadHeight(); });
      s.on('disconnect', function(r){ setStatus(false); });

      // Debounce auf Event-Sturm
      var t;
      function triggerDebounced(){ clearTimeout(t); t = setTimeout(function(){ refresh(); }, 250); }

      // Relevante Events
      s.on('resultUpdate',    triggerDebounced);
      s.on('results:updated', triggerDebounced);
      s.on('group:started',   triggerDebounced);
      s.on('round:advanced',  triggerDebounced);
      s.on('matches:reset',   triggerDebounced);
      s.on('groups:reseeded', triggerDebounced);
      s.on('schedule:recalculated', triggerDebounced);
    })();

    // === Start
    document.addEventListener('DOMContentLoaded', function(){
      setView('tiles');  // Default: Kachelansicht
      refresh();
      setInterval(refresh, 30000);
    });
  </script>
</body>
</html>
