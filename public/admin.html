
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì 3. K√∂nigsbrunner Mini-Fu√üball Hallenmasters</title>

  <style>
    /* ===== Dunkles Grund-Theme ===== */
    :root {
      --bg: #0f172a; --fg: #e5e7eb; --muted: #9ca3af; --accent: #22c55e; --danger: #ef4444;
      --card: #111827; --border: #1f2937;

      /* Gruppenfarben */
      --grpA-bg: #0b1b3a; --grpA-fg: #bfdbfe; --grpA-br: #1d4ed8;
      --grpB-bg: #2b0c0c; --grpB-fg: #fecaca; --grpB-br: #7f1d1d;
      --grpC-bg: #052e1b; --grpC-fg: #86efac; --grpC-br: #166534;
	  --grpD-bg: #1f2937; --grpD-fg: #fde68a; --grpD-br: #f59e0b;
      --grpE-bg: #1f2937; --grpE-fg: #ddd6fe; --grpE-br: #8b5cf6;
      --grpF-bg: #0b3640; --grpF-fg: #c0fafe; --grpF-br: #06b6d4;

      /* Statusfarben */
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;

      /* Hinweise */
      --hint-bg:#0b1020; --hint-br:#2a3b57; --hint-fg:#cbd5e1;
    }

    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--fg);
           font-family:system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Arial; }

    /* ===== Header mit Logo, QR und Basis-URL ===== */
    header { position: sticky; top: 0; z-index: 8; background: var(--card); border-bottom: 1px solid var(--border); }
    header .bar { display:flex; align-items:center; justify-content:space-between; padding: .75rem 1rem; gap: 1rem; }
    .leftWrap { display:flex; align-items:center; gap:1rem; flex-wrap:wrap; min-height:56px; }
    .titleWrap { display:flex; align-items:center; gap:.75rem; }
    .clubLogo { width:56px; height:56px; object-fit:contain; border-radius:6px; background:#0b1020; border:1px solid var(--border); }
    header h1 { margin:0; font-size:1.25rem; }

    .viewerLink { color: var(--muted); text-decoration: none; }

    /* QR-Container mit Quiet Zone */
    #qrImageHeader {
      width:256px; height:256px;
      background:#fff;
      padding:12px;
      border:1px solid var(--border);
      border-radius:4px;
      display:flex; align-items:center; justify-content:center;
      box-sizing:content-box;
    }

    .logoPath{
      display:inline-flex; align-items:center; gap:.35rem;
      background:var(--hint-bg); color:var(--hint-fg);
      border:1px dashed var(--hint-br); border-radius:8px;
      padding:.2rem .5rem; font-size:.85rem;
    }
    .logoError{
      display:none; margin-left:.5rem;
      color:#fecaca; background:#1b0f12; border:1px solid #7f1d1d;
      padding:.2rem .5rem; border-radius:6px; font-size:.85rem;
    }

    /* ===== Layout & Elemente ===== */
    main { padding:1rem; max-width:1200px; margin:0 auto; }
    section { margin-bottom:2rem; background:var(--card); border:1px solid var(--border); border-radius:8px; }
    section > header { position: static; z-index: auto; align-items:center; justify-content:space-between; gap:1rem; padding:.75rem 1rem; border-bottom:1px solid var(--border); display:flex; }
    .row { display:flex; flex-wrap:wrap; gap:.75rem; align-items:center; }
    .tableWrap { overflow-x:auto; }

    .btn { cursor:pointer; border:1px solid var(--border); background:#0b1020; color:#e5e7eb; padding:.5rem .75rem; border-radius:6px; font-weight:600; }
    .btn:hover { filter:brightness(1.08); }
    .btn-primary { border-color:#1d4ed8; background:#0b1b3a; color:#bfdbfe; }
    .btn-success { border-color:#166534; background:#052e1b; color:#86efac; }
    .btn-danger  { border-color:#7f1d1d; background:#2b0c0c; color:#fecaca; }
    .btn-muted   { border-color:var(--border); background:#0b1020; color:#9ca3af; }

    .btn.grpA { border-color:var(--grpA-br); background:var(--grpA-bg); color:var(--grpA-fg); }
    .btn.grpB { border-color:var(--grpB-br); background:var(--grpB-bg); color:var(--grpB-fg); }
    .btn.grpC { border-color:var(--grpC-br); background:var(--grpC-bg); color:var(--grpC-fg); }
	.btn.grpD { border-color:var(--grpD-br); background:var(--grpD-bg); color:var(--grpD-fg); }
    .btn.grpE { border-color:var(--grpE-br); background:var(--grpE-bg); color:var(--grpE-fg); }
    .btn.grpF { border-color:var(--grpF-br); background:var(--grpF-bg); color:var(--grpF-fg); }

    .input, select { background:#0b1020; color:var(--fg); border:1px solid var(--border); border-radius:6px; padding:.45rem .6rem; min-height:2rem; }

    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid var(--border); padding:.5rem; text-align:left; }
    th { color:#cbd5e1; font-weight:700; background:#0b1020; }
    tr:hover td { background:#0a0f1f; }

    .pill { display:inline-block; padding:.15rem .5rem; border-radius:999px; border:1px solid var(--border); font-size:.8rem; color:#9ca3af; }
    .pill.grpA { color:var(--grpA-fg); border-color:var(--grpA-br); background:var(--grpA-bg); }
    .pill.grpB { color:var(--grpB-fg); border-color:var(--grpB-br); background:var(--grpB-bg); }
    .pill.grpC { color:var(--grpC-fg); border-color:var(--grpC-br); background:var(--grpC-bg); }
	.pill.grpD { color:var(--grpD-fg); border-color:var(--grpD-br); background:var(--grpD-bg); }
    .pill.grpE { color:var(--grpE-fg); border-color:var(--grpE-br); background:var(--grpE-bg); }
    .pill.grpF { color:var(--grpF-fg); border-color:var(--grpF-br); background:var(--grpF-bg); }

    tr.grpA td { background:rgba(29,78,216,.08); }
    tr.grpB td { background:rgba(220,38,38,.08); }
    tr.grpC td { background:rgba(22,163,74,.08); }

    /* ===== Teams-Grid ===== */
    .teams-grid{ display: grid; grid-template-columns: repeat(3, minmax(320px, 1fr)); gap: 16px; align-items: start; padding: 1rem; }
    @media (max-width: 1100px){ .teams-grid{ grid-template-columns: repeat(2, minmax(320px, 1fr)); } }
    @media (max-width: 720px){ .teams-grid{ grid-template-columns: 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius:8px; padding: 12px; }
    .table-wrap { overflow:auto; }
    .table-wrap thead th { background:#0b1020; }

    /* ===== Zeitmanagement ===== */
    .tm-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .tm-row label { color:#cbd5e1; font-size:.85rem; }
    .tm-row .input { min-width: 120px; }

    /* ===== Sieger-Icon & Team-Text ===== */
    .winIcon { font-size: 1rem; margin-right: .35rem; vertical-align: middle; }
    .winnerText { color: var(--accent); font-weight: 600; }
    .loserText  { color: var(--muted); }
    .teamNameWrap { display:inline-flex; align-items:center; gap:.35rem; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="leftWrap">
        <div class="titleWrap">
          <img class="clubLogo" id="clubLogo" alt="Vereinslogo" />
          <div style="display:flex; flex-direction:column; gap:.25rem;">
            <h1>Admin ‚Äì 3. K√∂nigsbrunner Mini-Fu√üball Hallenmasters</h1>
            <div class="logoPath">
              Logo-Pfad: <code id="logoPathText">‚Äì</code>
              <span id="logoError" class="logoError">Logo konnte nicht geladen werden. Datei unter <code>public/assets/‚Ä¶</code> ablegen und Pfad pr√ºfen.</span>
            </div>
          </div>
        </div>

        <div class="row" style="gap:.5rem;">
          <label for="qrBase" class="pill" title="Protokoll+Host+Port (z.‚ÄØB. 192.168.0.25)">Viewer‚ÄëBasis:</label>
          <input id="qrBase" type="text" class="input" style="min-width:260px;" placeholder="192.168.0.25" />
          <button id="btnSaveQRBase" type="button" class="btn btn-primary">Speichern</button>
          <a id="viewerLink" class="viewerLink" target="_blank" rel="noopener">Viewer √∂ffnen</a>
        </div>
      </div>

      <div id="headerQR" style="display:flex; flex-direction:column; align-items:flex-end;">
        <div class="container">
			<img src="" id="qr-img">
		</div>
      </div>
    </div>
  </header>

  <main>
    <!-- Teams -->
    <section id="teamsSection">
      <header>
        <h2>Teams</h2>
        <div class="row">
          <button id="btnLoadTeams" type="button" class="btn btn-muted">Teams laden</button>
          <button id="btnDeleteAllTeams" type="button" class="btn btn-danger">Alle Teams l√∂schen</button>
        </div>
      </header>

      <div class="teams-grid" id="teamsGrid"></div>

      <div class="row" style="padding:1rem">
        <div class="row" style="flex:1 1 100%">
          <input id="teamName" class="input" placeholder="Teamname" />
          <select id="teamGroup" class="input">
            <option value="A">Gruppe A</option>
            <option value="B">Gruppe B</option>
            <option value="C">Gruppe C</option>
          </select>
          <button id="btnAddTeam" type="button" class="btn btn-success">Hinzuf√ºgen</button>
          <span id="teamsMsg" class="pill" style="display:none"></span>
        </div>

        <div class="row" style="flex:1 1 100%">
          <input id="teamsFile" type="file" accept=".csv,.json" class="input" />
          <button id="btnImportTeams" type="button" class="btn btn-primary">Teams aus Datei importieren</button>
          <span id="importMsg" class="pill" style="display:none"></span>
        </div>
      </div>
    </section>

    <!-- Matches -->
    <section id="matchesSection">
      <header>
        <h2>Spiele</h2>
        <div class="row">
          <button id="btnLoadMatches" type="button" class="btn btn-muted">Spiele laden</button>
          <button id="btnStartA" type="button" class="btn grpA">Gruppe A starten</button>
          <button id="btnStartB" type="button" class="btn grpB">Gruppe B starten</button>
          <button id="btnStartC" type="button" class="btn grpC">Gruppe C starten</button>
          <button id="btnNextRound" type="button" class="btn btn-primary">N√§chste Runde (oberste 3)</button>
          <span id="nextMsg" class="pill" style="display:none"></span>
          <button id="btnReset"  type="button" class="btn btn-danger">Spielplan zur√ºcksetzen</button>
		  <!-- Im Matches-Header (neben "N√§chste Runde" / "Reset") -->
		  <button id="btnReseedGroups" type="button" class="btn btn-primary">Gruppen neu zusammenstellen (nach 3 Runden)</button>
		  <span id="reseedMsg" class="pill" style="display:none"></span>
        </div>
      </header>

      <div class="row" style="padding:1rem">
        <div class="card" style="flex:1 1 100%">
          <h3 style="margin:.25rem 0 1rem; color:#cbd5e1;">Zeitmanagement (global)</h3>
          <div class="tm-row">
            <label for="sched-time">Start:</label>
            <input id="sched-time" type="time" class="input" step="60" />
            <label for="sched-dur">Dauer (min):</label>
            <input id="sched-dur" type="number" min="1" step="1" value="10" class="input" style="width:90px" />
            <label for="sched-break">Pause (min):</label>
            <input id="sched-break" type="number" min="0" step="1" value="2" class="input" style="width:90px" />
            <button id="sched-save" class="btn btn-primary">Speichern</button>
            <span id="timeMsg" class="pill" style="display:none; margin-left:auto;"></span>
          </div>
          <div style="margin-top:.5rem; color:#9ca3af; font-size:.85rem;">
            Raster: alphabetisch pro Slot (A ‚Üí B ‚Üí C). Runde&nbsp;2 von A bezieht sich zeitlich auf vorheriges C. Slot = <em>Dauer + Pause</em>.
          </div>
        </div>
      </div>

      <div class="tableWrap" style="padding:1rem">
        <table id="matchesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Gruppe</th>
              <th>Runde</th>
              <th>Feld</th>
              <th>Zeit</th>
              <th>Team A</th>
              <th>Team B</th>
              <th>Sieger</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ===== CHANGED: Socket.IO korrekt einbinden ===== -->
  <script src="/socket.io/socket.io.js"></script>

  <script src="qr_script.js"></script>

  <!-- Logo -->
  <script>
    const LOGO_PATH = '/assets/Fussballwappen_logo.png';
    const cacheBust = () => `?_v=${Date.now()}`;

    function setLogo(){
      const img = document.getElementById('clubLogo');
      const pathEl = document.getElementById('logoPathText');
      const errEl  = document.getElementById('logoError');

      if (!img || !pathEl) return;
      const url = LOGO_PATH + cacheBust();
      pathEl.textContent = LOGO_PATH;

      img.onload = () => { if (errEl) errEl.style.display = 'none'; };
      img.onerror = () => { if (errEl) errEl.style.display = 'inline-flex'; };
      img.src = url;
    }

    function initHeader(){
      setLogo();
    }
  </script>

  <!-- ===== API / State / Helpers ===== -->
  <script>
    const API_BASE = window.location.origin + '/api';

    async function safeFetch(path, init) {
      const url = API_BASE + path;
      const res = await fetch(url, init);
      if (!res.ok) {
        let text = ''; try { text = await res.text(); } catch {}
        throw new Error('HTTP ' + res.status + ' ' + res.statusText + (text ? ': ' + text : ''));
      }
      return res.json();
    }

    /* === API Wrapper === */
    const apiTeamsList      = () => safeFetch('/teams', { method:'GET' });
    const apiTeamsDeleteAll = () => safeFetch('/teams', { method:'DELETE' });
    const apiTeamAdd        = (name, groupName) => safeFetch('/teams', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, groupName }) });
    const apiTeamDelete     = (id) => safeFetch('/teams/' + encodeURIComponent(id), { method:'DELETE' });

    const apiMatchesList    = () => safeFetch('/matches', { method:'GET' });
    const apiGroupStart     = async (group) => {
      const schedule = getSchedule();
      if (!schedule) throw new Error('Kein g√ºltiger Zeitplan konfiguriert.');
      return safeFetch('/matches/start/' + encodeURIComponent(group), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ schedule })
      });
    };
    const apiMatchesReset   = () => safeFetch('/matches/reset', { method:'DELETE' });

    const apiWinnerSet      = (matchId, winnerTeamId) => safeFetch('/results/winner', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ matchId, winner: winnerTeamId }) });

    const apiNextRound      = async (groupName, results) => {
      const schedule = getSchedule();
      if (!schedule) throw new Error('Kein g√ºltiger Zeitplan konfiguriert.');
      return safeFetch('/funino/nextRound', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ groupName, results, schedule })
      });
    };

    const apiScheduleRecalc = (schedule) =>
      safeFetch('/schedule/recalculate', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ schedule })
      });

    /* === Aliases f√ºr UI === */
    const loadTeams      = apiTeamsList;
    const deleteAllTeams = apiTeamsDeleteAll;
    const addTeam        = apiTeamAdd;
    const deleteTeam     = apiTeamDelete;

    const loadMatches    = apiMatchesList;
    const startGroup     = apiGroupStart;
    const resetMatches   = apiMatchesReset;

    const setWinner      = apiWinnerSet;
    const nextRoundReq   = apiNextRound;

    /* === State === */
    let TEAMS = [];
    let MATCHES = [];

    /* === Helpers & Messages === */    
	function groupClass(g){
	  var x = String(g || '').trim().toUpperCase();
	  switch (x) {
		case 'A': return 'grpA';
		case 'B': return 'grpB';
		case 'C': return 'grpC';
		case 'D': return 'grpD';
		case 'E': return 'grpE';
		case 'F': return 'grpF';
		default:  return null;      // <-- NICHT '' zur√ºckgeben
	  }
	}

    function showMsg(selector, text, isError){
      const el = typeof selector==='string' ? document.querySelector(selector) : selector;
      if(!el) return;
      el.textContent = text; el.style.display='inline-block';
      el.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
      el.style.color = isError ? '#fecaca' : '#86efac';
      clearTimeout(el._t); el._t = setTimeout(() => { el.style.display='none'; }, 3000);
    }
	
	  
// API Wrapper
const apiReseedGroups = (schedule) =>
  fetch(window.location.origin + '/api/funino/reseedGroups', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ schedule })    // ‚Üê Zeitplan mitgeben
  }).then(res => {
    if (!res.ok) return res.text().then(txt => { throw new Error('HTTP '+res.status+' '+res.statusText+': '+txt); });
    return res.json();
  });

// Button-Handler
document.getElementById('btnReseedGroups')?.addEventListener('click', async () => {
  const msgEl = document.getElementById('reseedMsg');
  const show = (text, isError) => {
    msgEl.textContent = text; msgEl.style.display='inline-block';
    msgEl.style.borderColor = isError ? 'var(--danger)' : 'var(--accent)';
    msgEl.style.color      = isError ? '#fecaca'      : '#86efac';
    clearTimeout(msgEl._t); msgEl._t = setTimeout(() => { msgEl.style.display='none'; }, 4000);
  };
  try {
    const schedule = getSchedule(); // { timeHHMM, dur, brk } oder null
    const r = await apiReseedGroups(schedule);
    show(r.msg + ` (D:${r.result.matchesCreated.D}, E:${r.result.matchesCreated.E}, F:${r.result.matchesCreated.F})`);
    await refreshTeams?.();   // Tabellen D/E/F werden damit gef√ºllt
    await refreshMatches?.(); // neue Spiele sichtbar
  } catch (e) {
    show('Fehler: '+e.message, true);
  }
});

  </script>

  <!-- ===== Zeitmanagement (v2) ===== -->
  <script>
    const SCHED_KEY = 'admin.schedule.v2'; // { timeHHMM, dur, brk }

    function loadSchedule(){
      try { return JSON.parse(localStorage.getItem(SCHED_KEY) || 'null'); }
      catch { return null; }
    }
    function saveSchedule(cfg){ localStorage.setItem(SCHED_KEY, JSON.stringify(cfg)); }
    function getSchedule(){
      const s = loadSchedule();
      if(!s) return null;
      if(!/^\d{2}:\d{2}$/.test(s.timeHHMM)) return null;
      if(!Number.isFinite(s.dur) || s.dur <= 0) return null;
      if(!Number.isFinite(s.brk) || s.brk < 0) return null;
      return s;
    }

    function fillScheduleUI(){
      const cfg = loadSchedule() || {};
      const time = document.getElementById('sched-time');
      const dur  = document.getElementById('sched-dur');
      const brk  = document.getElementById('sched-break');
      if (time && cfg.timeHHMM) time.value = cfg.timeHHMM;
      if (dur  && Number.isFinite(cfg.dur)) dur.value = cfg.dur;
      if (brk  && Number.isFinite(cfg.brk)) brk.value = cfg.brk;
    }
    function wireScheduleUI(){
      const btn = document.getElementById('sched-save');
      btn && btn.addEventListener('click', async () => {
        const timeHHMM = document.getElementById('sched-time').value;
        const dur   = Number(document.getElementById('sched-dur').value);
        const brk   = Number(document.getElementById('sched-break').value);
        if (!/^\d{2}:\d{2}$/.test(timeHHMM)) { showMsg('#timeMsg', 'Bitte Startzeit im Format HH:MM setzen.', true); return; }
        if (!Number.isFinite(dur) || dur <= 0) { showMsg('#timeMsg', 'Dauer (min) ung√ºltig.', true); return; }
        if (!Number.isFinite(brk) || brk < 0) { showMsg('#timeMsg', 'Pause (min) ung√ºltig.', true); return; }

        const schedule = { timeHHMM, dur, brk };
        saveSchedule(schedule);
        showMsg('#timeMsg', 'Zeitplan gespeichert. Berechne Zeiten ...');

        try {
          await apiScheduleRecalc(schedule);   // serverseitige Rekalkulation aller geplanten Zeiten
          await refreshMatches();
          showMsg('#timeMsg', 'Zeiten aktualisiert.');
        } catch(e) {
          showMsg('#timeMsg', 'Recalc-Fehler: ' + e.message, true);
        }
      });
    }
  </script>

  <!-- ===== Teams: je Gruppe eigene Tabelle (ohne ‚ÄûGruppe‚Äú-Spalte) ===== -->
  <script>
    function buildTeamsGrid(groups){
      const grid = document.getElementById('teamsGrid');
      grid.innerHTML = '';
      groups.forEach(g => {
        const card = document.createElement('div'); card.className = 'card';
        const badge = document.createElement('span'); badge.className = 'pill ' + groupClass(g); badge.textContent = 'Gruppe ' + g; badge.style.marginBottom = '.5rem'; card.appendChild(badge);
        const wrap = document.createElement('div'); wrap.className = 'table-wrap';
        const table = document.createElement('table'); table.id = `teams-table-${g}`;
        const thead = document.createElement('thead'); thead.innerHTML = `
          <tr>
            <th style="width:80px;">ID</th>
            <th>Name</th>
            <th style="width:160px;">Aktion</th>
          </tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody'); tbody.id = `teams-tbody-${g}`; table.appendChild(tbody);
        wrap.appendChild(table); card.appendChild(wrap); grid.appendChild(card);
      });

      document.querySelectorAll('[id^="teams-table-"]').forEach(tbl => {
        tbl.addEventListener('click', async (e) => {
          const btn = e.target.closest('button'); if(!btn) return;
          const action = btn.dataset.action; const id = btn.dataset.id;
          if(action === 'delete'){
            try { await deleteTeam(id); await refreshTeams(); }
            catch (err) { showMsg('#teamsMsg', 'Fehler beim L√∂schen: ' + err.message, true); }
          }
        });
      });
    }

    function renderTeams(){
      const groupsSet = new Set(TEAMS.map(t => String(t.groupName || '').trim().toUpperCase()).filter(Boolean));
      const groups = groupsSet.size ? Array.from(groupsSet).sort() : ['A','B','C'];
      buildTeamsGrid(groups);
      groups.forEach(g => { const tbody = document.getElementById(`teams-tbody-${g}`); if (tbody) tbody.innerHTML = ''; });
      TEAMS.forEach(t => {
        const g = String(t.groupName || '').trim().toUpperCase();
        const tbody = document.getElementById(`teams-tbody-${g}`); if (!tbody) return;

        const tr = document.createElement('tr'); tr.classList.add(groupClass(t.groupName));
        const tdId = document.createElement('td'); tdId.textContent = t.id ?? '';
        const tdName = document.createElement('td'); tdName.textContent = t.name ?? '';
        const tdAction = document.createElement('td');
        const btnDel = document.createElement('button');
        btnDel.className='btn btn-danger'; btnDel.type='button';
        btnDel.dataset.action='delete'; btnDel.dataset.id=String(t.id);
        btnDel.textContent='L√∂schen';
        tdAction.appendChild(btnDel);

        tr.appendChild(tdId);
        tr.appendChild(tdName);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    async function refreshTeams(){
      try { TEAMS = await loadTeams(); renderTeams(); }
      catch(e){ showMsg('#teamsMsg', 'Fehler: '+e.message, true); }
    }
  </script>

  <!-- ===== Matches: Rendering (altes Layout, Bugfix Team A/B) ===== -->
  <script>
    function renderMatches() {
      const tbody = document.querySelector('#matchesTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!Array.isArray(MATCHES)) {
        showMsg('#nextMsg', 'Spieldaten ung√ºltig (kein Array).', true);
        return;
      }

      MATCHES.forEach(m => {
        const tr = document.createElement('tr');
        tr.classList.add(groupClass(m.groupName));

        const id        = m?.id ?? '';
        const groupName = m?.groupName ?? '';
        const round     = m?.round ?? '';
        const field     = m?.field ?? '';
        const teamAId   = m?.teamA_id ?? null;
        const teamBId   = m?.teamB_id ?? null;
        const teamAName = m?.teamA ?? (teamAId != null ? String(teamAId) : '');
        const teamBName = m?.teamB ?? (teamBId != null ? String(teamBId) : '');
        const planned   = m?.plannedStart ?? '‚Äì';        
		const winnerVal = m && typeof m.winner !== 'undefined' ? m.winner : null;
		const hasWinner = winnerVal !== null && winnerVal !== undefined;

        // Zellen
        const tdId    = document.createElement('td'); tdId.textContent = id;

        const tdGroup = document.createElement('td');
        const badge   = document.createElement('span');
        badge.className = 'pill ' + groupClass(groupName);
        badge.textContent = groupName;
        tdGroup.appendChild(badge);

        const tdRound = document.createElement('td'); tdRound.textContent = round;
        const tdField = document.createElement('td'); tdField.textContent = field;
        const tdTime  = document.createElement('td'); tdTime.textContent = planned;
				
		// Gewinner ermitteln		
		const isWinA = hasWinner && Number(winnerVal) === Number(teamAId);
		const isWinB = hasWinner && Number(winnerVal) === Number(teamBId);

		// Team A (nur Team A in dieser Spalte)
		const tdA = document.createElement('td');
		const wrapA = document.createElement('span'); wrapA.className = 'teamNameWrap';
		if (isWinA) {
		  const icoA = document.createElement('span'); icoA.className = 'winIcon'; icoA.textContent = 'üèÜ'; icoA.setAttribute('aria-label','Sieger');
		  const txtA = document.createElement('span'); txtA.className = 'winnerText'; txtA.textContent = teamAName;
		  wrapA.append(icoA, txtA);
		} else {
		  const txtA = document.createElement('span'); txtA.className = 'loserText'; txtA.textContent = teamAName;
		  wrapA.append(txtA);
		}
		tdA.replaceChildren(wrapA);

		// Team B (nur Team B in dieser Spalte)
		const tdB = document.createElement('td');
		const wrapB = document.createElement('span'); wrapB.className = 'teamNameWrap';
		if (isWinB) {
		  const icoB = document.createElement('span'); icoB.className = 'winIcon'; icoB.textContent = 'üèÜ'; icoB.setAttribute('aria-label','Sieger');
		  const txtB = document.createElement('span'); txtB.className = 'winnerText'; txtB.textContent = teamBName;
		  wrapB.append(icoB, txtB);
		} else {
		  const txtB = document.createElement('span'); txtB.className = 'loserText'; txtB.textContent = teamBName;
		  wrapB.append(txtB);
		}
		tdB.replaceChildren(wrapB);

		// Sieger-Spalte		
		const tdWinner = document.createElement('td');
		if (hasWinner) {
		  tdWinner.textContent = Number(winnerVal) === Number(teamAId) ? teamAName : teamBName;
		} else {
		  tdWinner.textContent = '';         // oder '\u00A0' f√ºr neutralen Leerraum
		}

        // Aktionen
        const tdAct = document.createElement('td'); tdAct.className = 'row';
        const grpCls = groupClass(groupName);

        const btnWinA = document.createElement('button');
        btnWinA.className = 'btn ' + grpCls; btnWinA.type = 'button'; btnWinA.dataset.action = 'winA';
        btnWinA.dataset.id = String(id); if (teamAId != null) btnWinA.dataset.team = String(teamAId);
        btnWinA.textContent = 'Sieger: Team A';

        const btnWinB = document.createElement('button');
        btnWinB.className = 'btn ' + grpCls; btnWinB.type = 'button'; btnWinB.dataset.action = 'winB';
        btnWinB.dataset.id = String(id); if (teamBId != null) btnWinB.dataset.team = String(teamBId);
        btnWinB.textContent = 'Sieger: Team B';

        tdAct.append(btnWinA, btnWinB);

        // Reihenfolge gem√§√ü Tabellenkopf
        tr.append(tdId, tdGroup, tdRound, tdField, tdTime, tdA, tdB, tdWinner, tdAct);
        tbody.appendChild(tr);
      });

      // Delegation: Sieger setzen
      tbody.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = Number(e.currentTarget.dataset.id);
          const winnerId = Number(e.currentTarget.dataset.team);
          if (!Number.isFinite(id) || !Number.isFinite(winnerId)) {
            alert('Ung√ºltige Match-/Team-ID.');
            return;
          }
          try { await setWinner(id, winnerId); await refreshMatches(); }
          catch (err) { alert('Fehler beim Setzen des Siegers: ' + err.message); }
        });
      });
    }

    async function refreshMatches(){
      try { MATCHES = await loadMatches(); renderMatches(); }
      catch(e){ showMsg('#nextMsg', 'Fehler: '+e.message, true); }
    }
  </script>

  <!-- ===== Next Round / Socket / UI ===== -->
  <script>
    function computeNextRoundPayloadFromTop3(){
      if (!Array.isArray(MATCHES)) throw new Error('Keine Spieldaten geladen.');
      const top3 = MATCHES.slice(0,3);
      if (top3.length !== 3) throw new Error('Mindestens 3 Spiele erforderlich.');
      const groupName = String(top3[0]?.groupName || '').trim();
      if (!groupName) throw new Error('Gruppe der obersten Spiele nicht ermittelbar.');
      const allSame = top3.every(m => String(m?.groupName || '').trim() === groupName);
      if (!allSame) throw new Error('Die obersten 3 Spiele geh√∂ren nicht zur gleichen Gruppe.');
      const results = top3.map(m => {
        const teamAId = Number(m?.teamA_id);
        const teamBId = Number(m?.teamB_id);
        const wRaw = m?.winner;
        if (wRaw == null) throw new Error('F√ºr Spiel ' + (m?.id || '?') + ' ist kein Sieger gesetzt.');
        const winnerId = Number(wRaw);
        if (!Number.isFinite(winnerId)) throw new Error('Ung√ºltiger Siegerwert bei Spiel ' + (m?.id || '?'));
        const loserId = (Number.isFinite(teamAId) && winnerId === teamAId) ? teamBId
                      : (Number.isFinite(teamBId) && winnerId === teamBId) ? teamAId
                      : NaN;
        if (!Number.isFinite(loserId)) throw new Error('Sieger geh√∂rt nicht zu Team A/B bei Spiel ' + (m?.id || '?'));
        return { winnerId, loserId, field: Number(m?.field) || undefined };
      });
      return { groupName, results };
    }

    function initSocket(){
      const base = window.location.origin;
      const s = window.io ? window.io(base, {
        path:'/socket.io',
        transports:['websocket','polling'],
        reconnectionAttempts:10,
        timeout:10000
      }) : null;
      if (!s) return;

      s.on('connect', () => console.log('Admin socket connected'));
      s.on('disconnect', (reason) => console.warn('Admin socket disconnected:', reason));
      s.on('connect_error', (err) => console.error('Admin socket connect_error:', err));

      // Reloads
      const reloadMatches = () => refreshMatches();
      s.on('resultUpdate', reloadMatches);
      s.on('results:updated', reloadMatches);
      s.on('group:started',   reloadMatches);
      s.on('round:advanced',  reloadMatches);
      s.on('matches:reset',   reloadMatches);
      s.on('schedule:recalculated', reloadMatches);
    }

    function wireUI(){
      // Teams
      document.getElementById('btnLoadTeams')?.addEventListener('click', refreshTeams);
      document.getElementById('btnDeleteAllTeams')?.addEventListener('click', async () => {
        if (!confirm('Wirklich ALLE Teams l√∂schen?')) return;
        try { await deleteAllTeams(); showMsg('#teamsMsg', 'Alle Teams wurden gel√∂scht.'); await refreshTeams(); }
        catch (err) { showMsg('#teamsMsg', 'Fehler beim L√∂schen aller Teams: ' + err.message, true); }
      });
      document.getElementById('btnAddTeam')?.addEventListener('click', async () => {
        const name = (document.getElementById('teamName').value || '').trim();
        const groupName = document.getElementById('teamGroup').value;
        if (!name) { showMsg('#teamsMsg','Bitte Teamname eingeben.', true); return; }
        try { await addTeam(name, groupName); showMsg('#teamsMsg','Team hinzugef√ºgt.'); document.getElementById('teamName').value=''; await refreshTeams(); }
        catch (err) { showMsg('#teamsMsg', 'Fehler: ' + err.message, true); }
      });
      document.getElementById('btnImportTeams')?.addEventListener('click', async () => {
        const inp = document.getElementById('teamsFile');
        if (!inp || !inp.files || !inp.files[0]) { showMsg('#importMsg','Bitte CSV/JSON Datei ausw√§hlen.', true); return; }
        try {
          const text = await inp.files[0].text(); let entries = [];
          if (inp.files[0].name.toLowerCase().endsWith('.json')) {
            const obj = JSON.parse(text); entries = Array.isArray(obj) ? obj : (Array.isArray(obj.teams) ? obj.teams : []);
          } else {
            entries = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).map(l => {
              const [name, groupName] = l.split(',').map(x => x?.trim());
              return { name, groupName };
            });
          }
          let ok=0, fail=0;
          for (const e of entries) {
            const n = (e.name || '').trim();
            const g = e.groupName ? String(e.groupName).trim().toUpperCase() : null;
            if (!n) { fail++; continue; }
            try { await addTeam(n, g); ok++; } catch { fail++; }
          }
          await refreshTeams();
          showMsg('#importMsg', `Import: ${ok}/${entries.length} erfolgreich, ${fail} fehlgeschlagen.`);
        } catch (err) { showMsg('#importMsg','Import‚ÄëFehler: ' + err.message, true); }
      });

      // Matches
      document.getElementById('btnLoadMatches')?.addEventListener('click', refreshMatches);
      document.getElementById('btnReset')?.addEventListener('click', async () => {
        if (!confirm('Spielplan wirklich zur√ºcksetzen?')) return;
        try { await resetMatches(); await refreshMatches(); }
        catch (err) { alert('Fehler beim Reset: ' + err.message); }
      });

      document.getElementById('btnStartA')?.addEventListener('click', async () => { try { await startGroup('A'); await refreshMatches(); } catch (err) { alert('Fehler: ' + err.message); } });
      document.getElementById('btnStartB')?.addEventListener('click', async () => { try { await startGroup('B'); await refreshMatches(); } catch (err) { alert('Fehler: ' + err.message); } });
      document.getElementById('btnStartC')?.addEventListener('click', async () => { try { await startGroup('C'); await refreshMatches(); } catch (err) { alert('Fehler: ' + err.message); } });

      document.getElementById('btnNextRound')?.addEventListener('click', async () => {
        try { const p = computeNextRoundPayloadFromTop3(); await nextRoundReq(p.groupName, p.results); showMsg('#nextMsg', 'N√§chste Runde f√ºr Gruppe ' + p.groupName + ' generiert.'); await refreshMatches(); }
        catch (err) { showMsg('#nextMsg','Fehler: ' + err.message, true); }
      });

      // Zeitplan
      wireScheduleUI();
      fillScheduleUI();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initHeader();   // Logo + QR
      wireUI();       // Buttons
      initSocket();   // Live-Updates
      refreshTeams();
      refreshMatches();
      setInterval(refreshMatches, 15000); // Fallback Polling
    });
  </script>
</body>
</html>
